<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libra A/B Experiment Report - Preview</title>
    <!-- <link rel="preconnect" href="https://fonts.googleapis.com"> -->
    <!-- <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> -->
    <!-- <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet"> -->
    <script src="./assets/js/tailwindcss.js"></script>
    <script src="./assets/js/babel.min.js"></script>
    <style>
        @layer base {
            :root {
                --background: 0 0% 100%;
                --foreground: 222.2 84% 4.9%;
                --card: 0 0% 100%;
                --card-foreground: 222.2 84% 4.9%;
                --popover: 0 0% 100%;
                --popover-foreground: 222.2 84% 4.9%;
                --primary: 221.2 83.2% 53.3%;
                --primary-foreground: 210 40% 98%;
                --secondary: 210 40% 96.1%;
                --secondary-foreground: 222.2 47.4% 11.2%;
                --muted: 210 40% 96.1%;
                --muted-foreground: 215.4 16.3% 46.9%;
                --accent: 210 40% 96.1%;
                --accent-foreground: 222.2 47.4% 11.2%;
                --destructive: 0 84.2% 60.2%;
                --destructive-foreground: 210 40% 98%;
                --border: 214.3 31.8% 91.4%;
                --input: 214.3 31.8% 91.4%;
                --ring: 221.2 83.2% 53.3%;
                --radius: 0.5rem;
            }
            .dark {
                --background: 222.2 84% 4.9%;
                --foreground: 210 40% 98%;
                --card: 222.2 84% 4.9%;
                --card-foreground: 210 40% 98%;
                --popover: 222.2 84% 4.9%;
                --popover-foreground: 210 40% 98%;
                --primary: 210 40% 98%;
                --primary-foreground: 222.2 47.4% 11.2%;
                --secondary: 217.2 32.6% 17.5%;
                --secondary-foreground: 210 40% 98%;
                --muted: 217.2 32.6% 17.5%;
                --muted-foreground: 215 20.2% 65.1%;
                --accent: 217.2 32.6% 17.5%;
                --accent-foreground: 210 40% 98%;
                --destructive: 0 62.8% 30.6%;
                --destructive-foreground: 210 40% 98%;
                --border: 217.2 32.6% 17.5%;
                --input: 217.2 32.6% 17.5%;
                --ring: 212.7 26.8% 83.9%;
            }
        }
        
        body {
            font-family: "Inter", sans-serif;
        }

        @font-face {
            font-family: 'DingTalk JinBuTi';
            src: url('assets/DingTalk-JinBuTi.woff2') format('woff2');
            font-display: swap;
        }

        .font-dingtalk {
            font-family: "DingTalk JinBuTi", sans-serif;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* AI Report Button Gradient */
        .btn-ai-report {
            background: linear-gradient(18deg, #3384FF 10%, #014BDE 50%, #A945FB 85%) !important;
            transition: all 0.3s ease !important;
        }
        .btn-ai-report:hover {
            background: linear-gradient(18deg, #5CA3FF 10%, #508AFF 50%, #CF8DFF 85%) !important;
        }
        .btn-ai-report:active {
            background: linear-gradient(18deg, #3384FF 10%, #014BDE 50%, #A945FB 85%) !important;
            opacity: 0.9 !important;
        }

        /* TipTap Editor Styles */
        .ProseMirror {
            outline: none;
            min-height: 60px;
        }
        .ProseMirror p.is-editor-empty:first-child::before {
            color: #94a3b8;
            content: attr(data-placeholder);
            float: left;
            height: 0;
            pointer-events: none;
        }
        .ProseMirror p {
            margin-top: 0.25em;
            margin-bottom: 0.25em;
            line-height: 1.6;
        }
        .ProseMirror ul {
            list-style-type: disc;
            padding-left: 1.5em;
        }
        .ProseMirror ol {
            list-style-type: decimal;
            padding-left: 1.5em;
        }
        
        /* Markdown Styles */
        .markdown-body ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 0.5em;
        }
        .markdown-body ol {
            list-style-type: decimal;
            padding-left: 1.5em;
            margin-bottom: 0.5em;
        }
        .markdown-body p {
            margin-bottom: 0.5em;
        }
        .markdown-body strong {
            font-weight: 600;
        }
        .ProseMirror strong {
            font-weight: bold;
        }
        .ProseMirror em {
            font-style: italic;
        }
        .editor-menu-bar button.is-active {
            background-color: hsl(var(--secondary));
            color: hsl(var(--foreground));
        }

        /* Mention Node Styles */
        .mention {
            display: inline-flex !important;
            align-items: center;
            vertical-align: middle;
            line-height: 1.2;
        }
        .mention[data-type="dimension"]::before {
            content: '';
            display: inline-block;
            width: 14px;
            height: 14px;
            background-image: url('./assets/images/icon/dimension.svg');
            background-size: contain;
            background-repeat: no-repeat;
            margin-right: 4px;
        }
        .mention[data-type="metric"]::before {
            content: '';
            display: inline-block;
            width: 14px;
            height: 14px;
            /* Lucide BarChart2 Icon SVG, colored indigo-500 (#6366f1) */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='18' y1='20' x2='18' y2='10'%3E%3C/line%3E%3Cline x1='12' y1='20' x2='12' y2='4'%3E%3C/line%3E%3Cline x1='6' y1='20' x2='6' y2='14'%3E%3C/line%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            margin-right: 4px;
        }
        .mention[data-type="analysis_card"]::before {
             content: '';
             display: inline-block;
             width: 14px;
             height: 14px;
             /* Lucide LayoutGrid Icon SVG */
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='7' height='7'%3E%3C/rect%3E%3Crect x='14' y='3' width='7' height='7'%3E%3C/rect%3E%3Crect x='14' y='14' width='7' height='7'%3E%3C/rect%3E%3Crect x='3' y='14' width='7' height='7'%3E%3C/rect%3E%3C/svg%3E");
             background-size: contain;
             background-repeat: no-repeat;
             margin-right: 4px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Roboto', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-background text-foreground antialiased">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useImperativeHandle } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { clsx } from 'https://esm.sh/clsx';
        import { twMerge } from 'https://esm.sh/tailwind-merge';
        import * as LucideIcons from 'https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0,react-dom@18.2.0';
        import { useEditor, EditorContent, BubbleMenu } from 'https://esm.sh/@tiptap/react@2.2.4?deps=react@18.2.0,react-dom@18.2.0';
        import StarterKit from 'https://esm.sh/@tiptap/starter-kit@2.2.4?deps=react@18.2.0,react-dom@18.2.0';
        import { Color } from 'https://esm.sh/@tiptap/extension-color@2.2.4?deps=react@18.2.0,react-dom@18.2.0';
        import TextStyle from 'https://esm.sh/@tiptap/extension-text-style@2.2.4?deps=react@18.2.0,react-dom@18.2.0';
        import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder@2.2.4?deps=react@18.2.0,react-dom@18.2.0';
        import Mention from 'https://esm.sh/@tiptap/extension-mention@2.2.4?deps=react@18.2.0,react-dom@18.2.0';
        import { ReactRenderer } from 'https://esm.sh/@tiptap/react@2.2.4?deps=react@18.2.0,react-dom@18.2.0';
        import { marked } from 'https://esm.sh/marked';
        import tippy from 'https://esm.sh/tippy.js@6.3.7';

        const {
            Menu, Bell, Settings, User, CheckCircle2, Search, PlayCircle, 
            MoreHorizontal, Plus, Sparkles, Filter, 
            Download, RefreshCw, AlertCircle, Share2, HelpCircle,
            BarChart2, FileText, LayoutDashboard, ArrowRight, ArrowUp, Trash2, GripVertical,
            Heading1, Heading2, Heading3, Type, Activity, Pencil, PanelLeftClose, PanelLeftOpen, ChevronDown, ChevronRight, ChevronLeft, Folder, FolderOpen,
            LayoutGrid, Languages, Globe,
            Copy, History, Target, Star, Clock, Calendar
        } = LucideIcons;

        // --- UTILS ---
        function cn(...inputs) {
            return twMerge(clsx(inputs));
        }

        // --- SHADCN/UI COMPONENTS ---

        const Button = React.forwardRef(({ className, variant = "default", size = "default", asChild = false, ...props }, ref) => {
            const variants = {
                default: "bg-primary text-primary-foreground hover:bg-primary/90",
                destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90",
                outline: "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
                secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
                ghost: "hover:bg-accent hover:text-accent-foreground",
                link: "text-primary underline-offset-4 hover:underline",
            };
            const sizes = {
                default: "h-8 rounded-md px-3",
                sm: "h-7 rounded-md px-3",
                xs: "h-6 rounded-md px-2",
                lg: "h-9 rounded-md px-4",
                icon: "h-10 w-10",
            };
            const onRefresh = () => {
              setHasBlockChanges(false);
              // In a real app, this might trigger a re-analysis or data refresh
              // For now, it just clears the notification
          };

          return (
                <button
                    className={cn(
                        "inline-flex items-center justify-center whitespace-nowrap rounded-md text-[13px] font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
                        variants[variant],
                        sizes[size],
                        className
                    )}
                    ref={ref}
                    {...props}
                />
            );
        });
        Button.displayName = "Button";

        const Badge = React.forwardRef(({ className, variant = "default", ...props }, ref) => {
             const variants = {
                default: "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
                secondary: "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
                destructive: "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
                outline: "text-foreground",
                success: "border-transparent bg-green-100 text-green-700 hover:bg-green-100/80",
                warning: "border-transparent bg-yellow-100 text-yellow-700 hover:bg-yellow-100/80",
            };
            return (
                <div className={cn("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2", variants[variant], className)} ref={ref} {...props} />
            );
        });
        Badge.displayName = "Badge";

        const Card = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("rounded-lg border bg-card text-card-foreground", className)} {...props} />
        ));
        Card.displayName = "Card";

        const CardHeader = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("flex flex-col space-y-1.5 p-6", className)} {...props} />
        ));
        CardHeader.displayName = "CardHeader";

        const CardTitle = React.forwardRef(({ className, ...props }, ref) => (
            <h3 ref={ref} className={cn("text-2xl font-semibold leading-none tracking-tight", className)} {...props} />
        ));
        CardTitle.displayName = "CardTitle";

        const CardContent = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
        ));
        CardContent.displayName = "CardContent";

        const Input = React.forwardRef(({ className, type, ...props }, ref) => (
            <input
                type={type}
                className={cn(
                    "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
                    className
                )}
                ref={ref}
                {...props}
            />
        ));
        Input.displayName = "Input";

        const Separator = React.forwardRef(({ className, orientation = "horizontal", decorative = true, ...props }, ref) => (
            <div
                ref={ref}
                data-orientation={orientation}
                className={cn(
                    "shrink-0 bg-border",
                    orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
                    className
                )}
                {...props}
            />
        ));
        Separator.displayName = "Separator";

        // Simple Table Components
        const Table = React.forwardRef(({ className, ...props }, ref) => (
            <div className="relative w-full overflow-auto">
                <table ref={ref} className={cn("caption-bottom text-sm w-max min-w-full table-fixed", className)} {...props} />
            </div>
        ));
        Table.displayName = "Table";

        const TableHeader = React.forwardRef(({ className, ...props }, ref) => (
            <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
        ));
        TableHeader.displayName = "TableHeader";

        const TableBody = React.forwardRef(({ className, ...props }, ref) => (
            <tbody ref={ref} className={cn("[&_tr:last-child]:border-0", className)} {...props} />
        ));
        TableBody.displayName = "TableBody";

        const TableRow = React.forwardRef(({ className, ...props }, ref) => (
            <tr ref={ref} className={cn("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted", className)} {...props} />
        ));
        TableRow.displayName = "TableRow";

        const TableHead = React.forwardRef(({ className, ...props }, ref) => (
            <th ref={ref} className={cn("h-9 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0", className)} {...props} />
        ));
        TableHead.displayName = "TableHead";

        const TableCell = React.forwardRef(({ className, ...props }, ref) => (
            <td ref={ref} className={cn("px-4 py-3 align-middle [&:has([role=checkbox])]:pr-0", className)} {...props} />
        ));
        TableCell.displayName = "TableCell";

        // --- CONSTANTS ---
        const SIDEBAR_ITEMS = [
          {
            id: 'core_focus',
            label: 'å®éªŒæ ¸å¿ƒå…³æ³¨',
            type: 'folder',
            children: [
              { id: 'core_metrics', label: 'æ ¸å¿ƒæŒ‡æ ‡3 (å…¨å±€)', type: 'item', isActive: true },
              { id: 'retention', label: 'æŒ‰è¿›ç»„æ—¶é—´æ‹†åˆ†ç•™å­˜(å…¨å±€)', type: 'item' },
            ]
          },
          {
            id: 'business_core',
            label: 'ä¸šåŠ¡æ ¸å¿ƒæŒ‡æ ‡',
            type: 'folder',
            children: [
              { id: 'live_stream', label: 'ä¸šåŠ¡æ ¸å¿ƒæŒ‡æ ‡-ç›´æ’­', type: 'item' },
              { id: 'base_metrics', label: 'ä¸šåŠ¡åŸºç¡€æŒ‡æ ‡(æ¨è)', type: 'item' },
              { id: 'shopping_cart', label: 'shopping_cart vvshopping', type: 'item' },
            ]
          },
          {
            id: 'conversion',
            label: 'ç›´æ’­è½¬åŒ–é“¾è·¯',
            type: 'folder',
            children: [
              { id: 'high_analysis', label: 'é«˜çº§åˆ†æä»»åŠ¡123', type: 'item' },
              { id: 'cart_vv', label: 'shopping_cart vv', type: 'item' },
            ]
          },
          {
            id: 'others',
            label: 'å…¶ä»–ç›‘æµ‹æŒ‡æ ‡',
            type: 'folder',
            children: []
          }
        ];

        const LIVE_METRICS_COLUMNS = [
          { id: 'user', label: 'User', subLabel: '' },
          { id: 'avg_7_days', label: 'è¿‘7å¤©äººå‡æŠ•ç¨¿æ•°', subLabel: '' },
          { id: 'avg_7_days_view', label: 'è¿‘7å¤©äººå‡è§‚çœ‹æ—¶é•¿', subLabel: '' },
          { id: 'avg_watch_time', label: 'äººå‡è§‚çœ‹æ—¶é•¿', subLabel: '' },
          { id: 'interact_rate', label: 'äº’åŠ¨ç‡', subLabel: '' },
          { id: 'stay_duration', label: 'åœç•™æ—¶é•¿', subLabel: '' },
          { id: 'conversion_rate', label: 'è½¬åŒ–ç‡', subLabel: '' },
        ];

        const generateRandomData = () => {
            const groups = [
                { id: 'v0', name: 'V0', isControl: true },
                { id: 'v1', name: 'V1', isControl: false },
                { id: 'v2', name: 'V2', isControl: false },
                { id: 'v3', name: 'V3', isControl: false },
            ];
            
            const metricConfigs = {
                user: { base: 8000000000, type: 'number' },
                avg_7_days: { base: 120, type: 'number' },
                avg_7_days_view: { base: 45, type: 'number' },
                avg_watch_time: { base: 120, type: 'number' },
                interact_rate: { base: 12.5, type: 'percent' },
                stay_duration: { base: 45, type: 'number' },
                conversion_rate: { base: 3.2, type: 'percent' },
            };

            const columns = Object.keys(metricConfigs);

            return groups.map(group => {
                const metrics = {};
                
                columns.forEach(colId => {
                    const config = metricConfigs[colId];
                    
                    if (group.isControl) {
                        metrics[colId] = { 
                            value: config.type === 'percent' 
                                ? config.base.toFixed(2) 
                                : config.base.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                        };
                    } else {
                        // Random significance
                        const rand = Math.random();
                        let significance = 'none';
                        let deltaVal = 0;
                        
                        if (rand < 0.15) {
                            significance = 'positive';
                            deltaVal = (Math.random() * 5 + 1); // +1% to +6%
                        } else if (rand < 0.25) {
                            significance = 'negative';
                            deltaVal = -(Math.random() * 5 + 1); // -1% to -6%
                        } else {
                            significance = 'none';
                            deltaVal = (Math.random() * 2 - 1); // -1% to +1%
                        }

                        const deltaType = deltaVal > 0 ? 'positive' : 'negative';
                        const deltaStr = (deltaVal > 0 ? '+' : '') + deltaVal.toFixed(4) + '%';
                        
                        // Calculate new value based on delta
                        const newValue = config.base * (1 + deltaVal / 100);
                         const valueStr = config.type === 'percent' 
                                ? newValue.toFixed(2) 
                                : newValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

                        const ciVal = Math.random() * 0.5 + 0.01;
                        const ciStr = 'Â±' + ciVal.toFixed(4) + '%';

                        metrics[colId] = {
                            value: valueStr,
                            delta: deltaStr,
                            deltaType: deltaType,
                            significance: significance,
                            confidenceInterval: ciStr,
                            subLabel: significance === 'none' ? 'æ— æ˜¾è‘—æ€§æ£€éªŒ' : undefined
                        };
                    }
                });

                return {
                    ...group,
                    metrics
                };
            });
        };

        const LIVE_METRICS_DATA = generateRandomData();

        const THINKING_STEPS = [
          {
            id: '1',
            title: 'å®éªŒæ ¸å¿ƒç›®æ ‡éªŒè¯',
            groups: [
              {
                  description: 'è´­ç‰©è¢‹é“¾è·¯å…³é”®èŠ‚ç‚¹å˜åŒ–ï¼Œè¯†åˆ«æå‡æˆ–æµå¤±ç¯èŠ‚',
                  items: [
                      { label: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-äº¤æ˜“é“¾è·¯', type: 'metric' }
                  ]
              },
              {
                  description: 'æ‹†åˆ†è®²è§£å¡ä¸è´§æ¶çš„è´¡çŒ®æ¯”ä¾‹ï¼Œçœ‹æ˜¯å¦çœŸå®ä½œç”¨äºè´§æ¶å¡',
                  items: [
                      { label: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-äº¤æ˜“é“¾è·¯', type: 'metric' },
                      { label: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-åˆ†ç»„ä»¶äº¤æ˜“é“¾è·¯æ˜ç»†', type: 'metric' }
                  ]
              }
            ]
          },
          {
            id: '2',
            title: 'ç”¨æˆ·è¡Œä¸ºå½±å“åˆ†æ',
            groups: [
              {
                  description: 'çœ‹æ’­è¡Œä¸ºæ˜¯å¦æœ‰å½±å“',
                  items: [
                      { label: 'ç”Ÿæ´»æœåŠ¡-ç›´æ’­ç”¨æˆ·æ ¸å¿ƒæŒ‡æ ‡', type: 'metric' },
                      { label: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-ç”¨æˆ·çœ‹æ’­æŒ‡æ ‡', type: 'metric' }
                  ]
              },
              {
                  description: 'ç›‘æ§äº’åŠ¨æŒ‡æ ‡ï¼Œåˆ¤æ–­ç”¨æˆ·å¯¹åŠŸèƒ½æ¥å—åº¦',
                  items: [
                      { label: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-å†…å®¹æ¶ˆè´¹æŒ‡æ ‡ç»„', type: 'metric' },
                      { label: 'ç”Ÿæ´»æœåŠ¡-ç›´æ’­ç”¨æˆ·æ ¸å¿ƒæŒ‡æ ‡', type: 'metric' }
                  ]
              }
            ]
          },
          {
            id: '3',
            title: 'åˆ†åœºæ™¯ä¸åˆ†è¡Œä¸šå·®å¼‚ï¼ˆæ³›åŒ–æ€§éªŒè¯ï¼‰',
            groups: [
              {
                  description: 'åˆ†è¡Œä¸šæ‹†è§£ï¼Œå®šä½æ ¸å¿ƒå—ç›Šè¡Œä¸š',
                  items: [
                      { 
                        label: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-å•†å“åˆ†è¡Œä¸šæ ¸å¿ƒæŒ‡æ ‡', 
                        type: 'metric',
                        children: [
                            { label: 'Cç«¯ä¸€çº§è¡Œä¸š', type: 'dimension' }
                        ]
                      }
                  ]
              },
              {
                  description: 'åˆ†åœºæ™¯æ‹†è§£ï¼ŒéªŒè¯åœ¨ä¸åŒåœºæ™¯æ•ˆæœå·®å¼‚',
                  items: [
                      { 
                        label: 'ç”Ÿæ´»æœåŠ¡-ç›´æ’­ç”¨æˆ·æ ¸å¿ƒæŒ‡æ ‡', 
                        type: 'metric',
                        children: [
                            { label: 'room_type (ç›´æ’­é—´ç±»å‹)', type: 'dimension' },
                            { label: 'is_all_groupon_same_city (å•†å“åŸå¸‚)', type: 'dimension' },
                            { label: 'is_has_local_verify_poi (æ˜¯å¦å¸¦POI)', type: 'dimension' }
                        ]
                      }
                  ]
              }
            ]
          },
          {
            id: '4',
            title: 'æ€§èƒ½æŒ‡æ ‡ç›‘æ§',
            groups: [
                {
                    items: [
                        { label: 'æœ¬åœ°ç›´æ’­-è´§æ¶-æ€§èƒ½æŒ‡æ ‡', type: 'metric' },
                        { label: 'æœ¬åœ°ç›´æ’­-è´§æ¶-æ€§èƒ½æŒ‡æ ‡-å‡å€¼', type: 'metric' }
                    ]
                }
            ]
          },
          {
              id: '5',
              title: 'æŠ¤æ æŒ‡æ ‡ç›‘æ§',
              groups: [
                  {
                      items: [
                          { label: 'APP-æ´»è·ƒå¤©æ•°', type: 'metric' },
                          { label: 'ç›´æ’­-ä¸šåŠ¡æ ¸å¿ƒã€ç´¯è®¡ã€‘', type: 'metric' },
                          { label: 'ç”µå•†-ä¸šåŠ¡æ ¸å¿ƒ-è‡ªç„¶æµé‡', type: 'metric' }
                      ]
                  }
              ]
          }
        ];

        // --- NEW BLOCK COMPONENTS ---

        const AddBlockMenu = ({ onSelect, onClose }) => {
            const items = [
                { id: 'metric', label: 'æŒ‡æ ‡æ•°æ®', icon: <img src="assets/images/icon/Chart.svg" width="14" height="14" alt="Chart" />},
                { id: 'analysis', label: 'é«˜çº§åˆ†æ', icon: <img src="assets/images/icon/DrillDown.svg" width="14" height="14" alt="DrillDown" />},
                { id: 'smart', label: 'æ™ºèƒ½åˆ†æ', icon: <Sparkles size={14}/>},
                { id: 'text', label: 'æ–‡æœ¬å—', icon: <img src="assets/images/icon/Text.svg" width="14" height="14" alt="Text" />},
                { id: 'group', label: 'åˆ†ç»„', icon: <img src="assets/images/icon/folder.svg" width="14" height="14" alt="folder" />},
            ];

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (!event.target.closest('.add-block-menu') && !event.target.closest('.add-trigger')) {
                        onClose();
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [onClose]);

            return (
                <div className="add-block-menu absolute left-1/2 -translate-x-1/2 z-1000 mt-2 w-64 bg-background border rounded-lg shadow-xl p-2 animate-in fade-in zoom-in-95 duration-200">
                    {items.map(item => (
                        <div 
                            key={item.id}
                            className="flex items-center px-3 py-2 hover:bg-muted rounded-md cursor-pointer transition-colors group"
                            onClick={(e) => { e.stopPropagation(); onSelect(item.id); }}
                        >
                            <div className="mr-3 text-foreground group">{item.icon}</div>
                            <div>
                                <div className="text-[13px] text-foreground">{item.label}</div>
                            </div>
                        </div>
                    ))}
                </div>
            )
        }

        const MetricSelectorBlock = ({ onConfirm }) => {
            const [isOpen, setIsOpen] = useState(false);
            const groups = [
                { id: 'g1', name: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-ç”¨æˆ·æ ¸å¿ƒæŒ‡æ ‡', count: 12 },
                { id: 'g2', name: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-äº¤æ˜“é“¾è·¯', count: 8 },
                { id: 'g3', name: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-å•†å“åˆ†è¡Œä¸šæ ¸å¿ƒæŒ‡æ ‡', count: 15 },
            ];

            return (
                <div className="p-2 bg-background rounded-xl">
                    <div className="relative">
                        <div 
                            className={cn(
                                "flex items-center justify-between w-full px-4 py-2 bg-background rounded-lg hover:bg-blue-50 focus:bg-blue-50 rounded-lg cursor-pointer transition-colors group",
                                isOpen ? "bg-blue-50 ring-2 ring-blue-100" : ""
                            )}
                            onClick={() => setIsOpen(!isOpen)}
                        >
                            <div className="flex items-center text-muted-foreground group-hover:text-primary transition-colors">
                                <img src="assets/images/icon/Chart.svg" width="14" height="14" alt="Chart" className="mr-3" />
                                <span className="text-[13px]">é€‰æ‹©æŒ‡æ ‡ç»„</span>
                            </div>
                            <ChevronRight size={14} className={cn("text-muted-foreground transition-transform", isOpen ? "rotate-90" : "")} />
                        </div>

                        {isOpen && (
                            <div className="absolute top-full left-0 w-full mt-2 bg-background border rounded-lg shadow-lg z-[500] p-2 animate-in fade-in zoom-in-95 duration-200">
                                {groups.map(g => (
                                    <div 
                                        key={g.id}
                                        className="px-3 h-8 hover:bg-muted cursor-pointer flex justify-between items-center text-[13px] rounded-md transition-colors"
                                        onClick={() => onConfirm(g.name)}
                                    >
                                        <span className="text-foreground">{g.name}</span>
                                        <Badge variant="secondary" className="text-[11px] h-5 px-1.5 bg-muted text-muted-foreground">{g.count}</Badge>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            )
        }

        const AnalysisSelectorBlock = ({ onConfirm }) => {
            const [isOpen, setIsOpen] = useState(false);
             const tasks = [
                { id: 't1', name: 'ç›´æ’­é—´äº’åŠ¨æ·±åº¦åˆ†æ', type: 'å½’å› åˆ†æ' },
                { id: 't2', name: 'åˆ†æ—¶æ®µæµé‡è½¬åŒ–æ¼æ–—', type: 'æ¼æ–—åˆ†æ' },
                { id: 't3', name: 'ç”¨æˆ·ç•™å­˜ä¸å¤è´­å‘¨æœŸ', type: 'ç•™å­˜åˆ†æ' },
            ];

            return (
                <div className="p-2 bg-background rounded-xl">
                    <div className="relative">
                        <div 
                            className={cn(
                                "flex items-center justify-between w-full px-4 py-2 bg-background rounded-lg hover:bg-blue-50 focus:bg-blue-50 cursor-pointer transition-colors group",
                                isOpen ? "bg-blue-50 ring-2 ring-blue-100" : ""
                            )}
                            onClick={() => setIsOpen(!isOpen)}
                        >
                            <div className="flex items-center text-muted-foreground group-hover:text-primary transition-colors">
                                <img src="assets/images/icon/DrillDown.svg" width="14" height="14" alt="DrillDown" className="mr-3" />
                                <span className="text-[13px]">é€‰æ‹©é«˜çº§åˆ†æä»»åŠ¡</span>
                            </div>
                            <ChevronRight size={14} className={cn("text-muted-foreground transition-transform", isOpen ? "rotate-90" : "")} />
                        </div>

                        {isOpen && (
                            <div className="absolute top-full left-0 w-full mt-2 bg-background border rounded-lg shadow-lg z-[9999] p-2 animate-in fade-in zoom-in-95 duration-200">
                                {tasks.map(t => (
                                    <div 
                                        key={t.id}
                                        className="px-3 h-8 hover:bg-muted cursor-pointer flex justify-between items-center text-[13px] rounded-md transition-colors"
                                        onClick={() => onConfirm(t.name)}
                                    >
                                        <span className="text-foreground">{t.name}</span>
                                        <Badge variant="secondary" className="text-[11px] h-5 px-1.5 bg-muted text-muted-foreground">{t.type}</Badge>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            )
        }



        // --- BLOCK COMPONENTS ---

        const BlockWrapper = ({ id, type, sectionId, children, onDelete, onInsertAfter, isHovered, setIsHovered, showAddMenu, onAddMenuSelect, onCloseMenu, onMoveBlock }) => {
            const [isDragging, setIsDragging] = useState(false);
            const [dropPosition, setDropPosition] = useState(null); // 'before' | 'after' | null

            const handleDragStart = (e) => {
                setIsDragging(true);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('application/json', JSON.stringify({ sectionId, blockId: id }));
            };

            const handleDragEnd = () => {
                setIsDragging(false);
                setDropPosition(null);
            };

            const handleDragOver = (e) => {
                e.preventDefault(); // Necessary to allow dropping
                e.stopPropagation();

                const rect = e.currentTarget.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                
                if (e.clientY < midY) {
                    setDropPosition('before');
                } else {
                    setDropPosition('after');
                }
            };

            const handleDragLeave = () => {
                setDropPosition(null);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDropPosition(null);

                try {
                    const data = JSON.parse(e.dataTransfer.getData('application/json'));
                    if (data.sectionId && data.blockId) {
                        onMoveBlock(data.sectionId, data.blockId, sectionId, id, dropPosition);
                    }
                } catch (err) {
                    console.error("Drop failed", err);
                }
            };

            return (
                <div 
                    id={id}
                    className={cn(
                        "group relative mb-4 transition-all", 
                        isDragging ? "opacity-30" : "opacity-100",
                        showAddMenu ? "z-30" : (isHovered === id ? "z-20" : "")
                    )}
                    onMouseEnter={() => setIsHovered(id)}
                    onMouseLeave={() => setIsHovered(null)}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                >
                    {/* Drop Indicator */}
                    {dropPosition === 'before' && (
                        <div className="absolute -top-2 left-0 w-full h-0.5 bg-blue-500 z-50 pointer-events-none"></div>
                    )}
                    {dropPosition === 'after' && (
                        <div className="absolute -bottom-2 left-0 w-full h-0.5 bg-blue-500 z-50 pointer-events-none"></div>
                    )}

                    {/* Left Actions - Grip */}
                    <div className={cn(
                        "absolute -left-6 top-0 h-full flex flex-col items-center justify-start pt-0 transition-opacity duration-200",
                        isHovered === id ? "opacity-100" : "opacity-0"
                    )}
                        draggable
                        onDragStart={handleDragStart}
                        onDragEnd={handleDragEnd}
                    >
                        <div className="p-1 text-muted-foreground hover:bg-secondary rounded cursor-grab active:cursor-grabbing">
                            <GripVertical size={14} />
                        </div>
                    </div>

                    {/* Right Actions - Delete */}
                    <div className={cn(
                        "absolute -right-6 top-0 h-full flex flex-col items-center justify-start pt-0 transition-opacity duration-200",
                        isHovered === id ? "opacity-100" : "opacity-0"
                    )}>
                        <div 
                            className="p-1 text-muted-foreground hover:bg-destructive/10 hover:text-destructive rounded cursor-pointer transition-colors"
                            onClick={() => onDelete(id)}
                        >
                            <Trash2 size={14} />
                        </div>
                    </div>

                    {/* Content */}
                    <div className={cn(
                        "rounded-xl transition-all duration-200",
                        (type !== 'divider' && type !== 'metric_selector' && type !== 'analysis_selector') && "overflow-hidden",
                        (type === 'divider' || type === 'summary' || type === 'ask_ai') ? "border-0 bg-transparent" : "border",
                        isHovered === id && (type !== 'divider' && type !== 'summary') ? "border-primary/50 shadow-sm bg-white" : ((type !== 'divider' && type !== 'summary' && type !== 'ask_ai') ? "border-[#21252C]/12 bg-transparent" : "")
                    )}>
                        {children}
                    </div>

                    {/* Bottom Insert Trigger (Hover Zone) */}
                    <div className={cn(
                        "absolute -bottom-6 left-0 w-full h-8 flex items-center justify-center z-20 cursor-pointer transition-opacity",
                        showAddMenu ? "opacity-100" : "opacity-0 hover:opacity-100"
                    )}>
                        {/* The Line */}
                        <div className="absolute w-full h-[2px] bg-primary/20"></div>
                        
                        {/* The Button */}
                        <div className="relative add-trigger z-10">
                            <Button 
                                variant="ghost" 
                                size="sm" 
                                className={cn(
                                    "h-6 w-6 rounded-full border shadow-sm p-0 transition-all bg-background",
                                    showAddMenu ? "bg-primary text-primary-foreground rotate-45 border-primary" : "text-muted-foreground hover:text-primary hover:border-primary"
                                )}
                                onClick={(e) => { e.stopPropagation(); showAddMenu ? onCloseMenu() : onInsertAfter(id); }}
                            >
                                <Plus size={14} />
                            </Button>
                            {showAddMenu && <AddBlockMenu onSelect={onAddMenuSelect} onClose={onCloseMenu} />}
                        </div>
                    </div>
                </div>
            );
        };

        const AddBlockArea = ({ onSelect }) => {
            const items = [
                { id: 'metric', label: 'æŒ‡æ ‡æ•°æ®', icon: <img src="assets/images/icon/Chart.svg" width="16" height="16" alt="Chart" /> },
                { id: 'analysis', label: 'é«˜çº§åˆ†æ', icon: <img src="assets/images/icon/DrillDown.svg" width="16" height="16" alt="DrillDown" /> },
                { id: 'smart', label: 'æ™ºèƒ½åˆ†æ', icon: <Sparkles size={16}/> },
                { id: 'text', label: 'æ–‡æœ¬å—', icon: <img src="assets/images/icon/Text.svg" width="16" height="16" alt="Text" /> },
                { id: 'group', label: 'åˆ†ç»„', icon: <img src="assets/images/icon/folder.svg" width="16" height="16" alt="folder" /> },
            ];

            return (
                <div className="flex items-center justify-between p-2 gap-0 bg-background border rounded-xl hover:shadow-sm transition-all w-[640px] mx-auto">
                    {items.map(item => (
                        <div 
                            key={item.id}
                            className="flex flex-1 items-center justify-center cursor-pointer text-muted-foreground hover:text-foreground hover:bg-muted/50 rounded-lg py-3 transition-colors space-x-[6px] group"
                            onClick={() => onSelect(item.id)}
                        >
                            <div className="p-0 rounded-md transition-colors flex items-center">
                                {item.icon}
                            </div>
                            <span className="text-sm font-medium">{item.label}</span>
                        </div>
                    ))}
                </div>
            );
        };

        const PromptEditorButton = ({ className, variant = "outline", size = "sm", defaultPrompt = "", onSave }) => {
            const [isPopoverOpen, setIsPopoverOpen] = useState(false);
            const [promptText, setPromptText] = useState(defaultPrompt || "ä»¥ä¸‹æ˜¯ä¸šåŠ¡æ ¸å¿ƒæŒ‡æ ‡ï¼Œè¦æ±‚å¿…é¡»æ£€æŸ¥è¯¥æŒ‡æ ‡ç»„ä¸­çš„æ‰€æœ‰æŒ‡æ ‡æ˜¯å¦æœ‰æ˜¾è‘—å˜åŒ–ï¼›éœ€è¦æŒ‰ç…§ ğŸ§¬ ç›´æ’­é—´ç±»å‹ (room_tpye) è¿›è¡Œæ‹†åˆ†ã€‚å®Œæˆå›ºå®šæ¡†æ¶åˆ†æåï¼Œè¯·ä»å…¶ä»–ä¸šåŠ¡æ–¹å‘/æ·±å…¥åˆ†æçš„è§’åº¦è¡¥å……æœªè¦†ç›–çš„æœ‰ä»·å€¼ä¿¡æ¯ï¼Œé¼“åŠ±è·³å‡ºä¼ ç»Ÿè§†è§’ã€‚");
            const [showToast, setShowToast] = useState(false);

            const handleSavePrompt = () => {
                setIsPopoverOpen(false);
                setShowToast(true);
                setTimeout(() => setShowToast(false), 3000);
                if (onSave) {
                    onSave(promptText);
                }
            };

            return (
                <div className="relative inline-block">
                    {showToast && (
                            <div className="fixed top-4 right-1/2 translate-x-1/2 z-[100] bg-white text-foreground border shadow-lg px-4 py-2 rounded-md text-sm animate-in fade-in slide-in-from-top-5 duration-300 flex items-center">
                            <CheckCircle2 size={16} className="text-green-500 mr-2" />
                            ä¿å­˜æˆåŠŸ
                            </div>
                    )}
                    <Button 
                        variant={variant}
                        size={size}
                        className={className}
                        onClick={() => setIsPopoverOpen(!isPopoverOpen)}
                    >
                        <img src="assets/images/icon/ai_writing.svg" width="13" height="13" className="mr-1.5" alt="AI Writing" /> ä¿®æ”¹Prompt
                    </Button>
                    
                    {isPopoverOpen && (
                        <div className="absolute top-full right-0 mt-2 w-[480px] z-[999] bg-white border rounded-lg shadow-xl px-5 py-4 animate-in fade-in zoom-in-95 duration-200 text-left cursor-default">
                                <div className="font-medium text-sm mb-3 text-gray-900">ä¿®æ”¹å†™æŠ¥å‘Šçš„prompt</div>
                                <div className="border rounded-md p-3 bg-gray-50/50 mb-4">
                                <textarea 
                                    className="w-full h-24 text-[13px] bg-transparent border-none resize-none focus:ring-0 focus:outline-none leading-relaxed text-gray-600"
                                    value={promptText}
                                    onChange={(e) => setPromptText(e.target.value)}
                                />
                                </div>
                                <div className="flex justify-end space-x-2">
                                    <Button variant="outline" size="xs" className="h-6 px-3 text-[12px]" onClick={() => setIsPopoverOpen(false)}>å–æ¶ˆ</Button>
                                    <Button size="xs" className="h-6 px-3 text-[12px] bg-blue-600 hover:bg-blue-700 text-white" onClick={handleSavePrompt}>ä¿å­˜</Button>
                                </div>
                        </div>
                    )}
                </div>
            );
        };

        const SummaryBlock = ({ data }) => {
            const [displayData, setDisplayData] = useState(data);
            const [isStreaming, setIsStreaming] = useState(false);

            useEffect(() => {
                if (!isStreaming) {
                    setDisplayData(data);
                }
            }, [data, isStreaming]);

            const handleRefresh = () => {
                if (isStreaming) return;
                setIsStreaming(true);
                setDisplayData([]);
                
                let index = 0;
                // Start with a small delay to show empty state/loading
                setTimeout(() => {
                    const interval = setInterval(() => {
                        if (index < data.length) {
                            // Use functional update to ensure we are appending to the current state
                            // Note: inside interval, 'index' is closure captured, but we just increment it.
                            // We need to capture the current 'item' from 'data'.
                            const currentItem = data[index];
                            setDisplayData(prev => [...prev, currentItem]);
                            index++;
                        } else {
                            clearInterval(interval);
                            setIsStreaming(false);
                        }
                    }, 800); // 800ms delay between items
                }, 300);
            };

            return (
                <Card className="border-indigo-100 rounded-xl w-full relative" style={{ background: 'linear-gradient(358deg, white 57%, #F4F5FF 100%)' }}>
                    <CardHeader className={cn("flex flex-row items-center justify-between space-y-0 pb-3 px-6 pt-3")}>
                        <CardTitle className="text-[12px] font-medium flex items-center text-muted-foreground">
                            <img src="assets/images/icon/ai_summary.svg" width="14" height="14" alt="Text" className="mr-2" />
                            å®éªŒæ€»ç»“
                        </CardTitle>
                        <div className="flex space-x-3 relative">
                            <PromptEditorButton 
                                variant="outline" 
                                size="sm" 
                                className="h-6 text-[12px] bg-white border-gray-200 text-foreground/70 hover:bg-gray-100 hover:text-foreground/70 shadow-sm transition-all"
                                onSave={handleRefresh}
                            />

                            <Button 
                                variant="outline" 
                                size="icon" 
                                className="h-6 w-6 bg-white border-gray-200 text-muted-foreground hover:bg-gray-100 shadow-sm transition-all"
                                onClick={handleRefresh}
                                disabled={isStreaming}
                            >
                                <RefreshCw size={13} className={isStreaming ? "animate-spin" : ""}/>
                            </Button>
                        </div>
                    </CardHeader>
                    <CardContent className="px-6 pb-4 pt-0">
                        <div className="text-[13px] text-foreground space-y-0 leading-relaxed min-h-[80px]">
                            {displayData.map((item, index) => (
                                <div key={index} className="flex items-start animate-in fade-in slide-in-from-bottom-2 duration-500">
                                    <div className="w-1 h-1 rounded-full bg-foreground mt-3 mr-2 shrink-0"></div>
                                    <div className="text-[13px] leading-6 flex-1">
                                        <span className="font-bold text-foreground mr-1">{item.title}</span>
                                        {item.content}
                                    </div>
                                </div>
                            ))}
                            {isStreaming && (
                                <div className="flex items-center gap-1 mt-2 ml-4 h-7">
                                    <span className="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-bounce [animation-delay:-0.3s]"></span>
                                    <span className="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-bounce [animation-delay:-0.15s]"></span>
                                    <span className="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-bounce"></span>
                                </div>
                            )}
                        </div>
                    </CardContent>
                </Card>
            );
        };

        const RichTextEditor = ({ content, onUpdate, editable = true }) => {
            const editor = useEditor({
                extensions: [
                    StarterKit,
                    TextStyle,
                    Color,
                    Placeholder.configure({
                        placeholder: 'è¯·è¾“å…¥æ–‡æœ¬ï¼Œå¯¹å®éªŒã€æ•°æ®ç­‰è¿›è¡Œæè¿°',
                    }),
                ],
                content: content,
                editable: editable,
                onUpdate: ({ editor }) => {
                    onUpdate(editor.getHTML());
                },
                editorProps: {
                    attributes: {
                        class: 'prose prose-sm focus:outline-none text-foreground max-w-none w-full text-[13px]',
                    },
                },
            });

            // Effect to update content if it changes externally (and isn't focused to avoid cursor jumps, ideally)
            // But for simple block updates, re-setting content might be needed if switching blocks.
            // However, useEditor initial content is only set once.
            // If we need reactive content updates:
            useEffect(() => {
                if (editor && content !== editor.getHTML()) {
                    // Only update if content is different to avoid loops/cursor resets
                    // editor.commands.setContent(content);
                }
            }, [content, editor]);

            if (!editor) {
                return null;
            }

            return (
                <div className="relative group/editor">
                    {editable && (
                        <BubbleMenu editor={editor} tippyOptions={{ duration: 100 }}>
                            <div className="flex items-center space-x-1 bg-background border rounded-md shadow-md p-1">
                                <Button
                                    variant="ghost"
                                    size="xs"
                                    onClick={() => editor.chain().focus().toggleBold().run()}
                                    className={cn("h-7 w-7 p-0", editor.isActive('bold') ? 'bg-secondary text-foreground' : 'text-muted-foreground')}
                                >
                                    <span className="font-bold">B</span>
                                </Button>
                                <Button
                                    variant="ghost"
                                    size="xs"
                                    onClick={() => editor.chain().focus().toggleItalic().run()}
                                    className={cn("h-7 w-7 p-0", editor.isActive('italic') ? 'bg-secondary text-foreground' : 'text-muted-foreground')}
                                >
                                    <span className="italic">I</span>
                                </Button>
                                <Button
                                    variant="ghost"
                                    size="xs"
                                    onClick={() => editor.chain().focus().toggleStrike().run()}
                                    className={cn("h-7 w-7 p-0", editor.isActive('strike') ? 'bg-secondary text-foreground' : 'text-muted-foreground')}
                                >
                                    <span className="line-through">S</span>
                                </Button>
                                <Separator orientation="vertical" className="h-4 mx-1" />
                                <Button
                                    variant="ghost"
                                    size="xs"
                                    onClick={() => editor.chain().focus().setColor('#958DF1').run()}
                                    className={cn("h-7 w-7 p-0", editor.isActive('textStyle', { color: '#958DF1' }) ? 'bg-secondary' : '')}
                                >
                                    <div className="w-3 h-3 rounded-full bg-[#958DF1]"></div>
                                </Button>
                                <Button
                                    variant="ghost"
                                    size="xs"
                                    onClick={() => editor.chain().focus().setColor('#F98181').run()}
                                    className={cn("h-7 w-7 p-0", editor.isActive('textStyle', { color: '#F98181' }) ? 'bg-secondary' : '')}
                                >
                                    <div className="w-3 h-3 rounded-full bg-[#F98181]"></div>
                                </Button>
                                <Button
                                    variant="ghost"
                                    size="xs"
                                    onClick={() => editor.chain().focus().unsetColor().run()}
                                    className="h-7 w-7 p-0 text-muted-foreground"
                                >
                                    <span className="text-xs">Rx</span>
                                </Button>
                            </div>
                        </BubbleMenu>
                    )}
                    <EditorContent editor={editor} className="min-h-[40px]" />
                </div>
            );
        };

        const TextBlock = ({ content, onUpdateContent }) => (
            <div className="p-2 bg-white rounded-lg">
                <div className="text-muted-foreground leading-relaxed text-[13px]">
                    <RichTextEditor content={content} onUpdate={onUpdateContent} />
                </div>
            </div>
        );

        const ConfigBadge = ({ label, value, options, onSelect }) => {
            const [isOpen, setIsOpen] = useState(false);
            const menuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                if (isOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isOpen]);

            return (
                <div className="flex items-center space-x-2 relative" ref={menuRef}>
                    <span className="text-muted-foreground">{label}</span>
                    <div 
                        className="inline-flex items-center justify-center rounded-full border border-transparent bg-blue-50 text-blue-600 hover:bg-blue-100 cursor-pointer font-medium px-2 h-5 text-[10px] transition-colors select-none"
                        onClick={() => setIsOpen(!isOpen)}
                    >
                        {value}
                    </div>
                    {isOpen && (
                        <div className="absolute top-full left-0 mt-1 bg-background border rounded-md shadow-lg z-[60] min-w-[80px] py-1 flex flex-col animate-in fade-in zoom-in-95 duration-200">
                            {options.map((opt) => (
                                <div 
                                    key={opt} 
                                    className="text-xs px-3 py-1.5 hover:bg-muted cursor-pointer text-foreground whitespace-nowrap"
                                    onClick={() => {
                                        onSelect(opt);
                                        setIsOpen(false);
                                    }}
                                >
                                    {opt}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };
        const TableBlock = ({ title, data, columns, level, onTriggerAIAnalysis }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            const [viewMode, setViewMode] = useState('cumulative'); // 'cumulative' or 'daily'
            const [config, setConfig] = useState({
                metricType: 'CUPED',
                significanceLevel: '5%',
                multiCorrection: 'å¼€',
                dimCorrection: 'å…³'
            });
            const [isConfigMenuOpen, setIsConfigMenuOpen] = useState(false);
            const [hoveredColId, setHoveredColId] = useState(null);
            const configMenuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (configMenuRef.current && !configMenuRef.current.contains(event.target)) {
                        setIsConfigMenuOpen(false);
                    }
                };
                if (isConfigMenuOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isConfigMenuOpen]);

            return (
                <div className="overflow-hidden">
                    <div className={cn("px-4 border-b bg-white flex justify-between items-center py-3 h-[52px]")}>
                        <div className="flex items-center space-x-3">
                            <div 
                                className="cursor-pointer text-muted-foreground hover:text-foreground transition-colors mr-1"
                                onClick={() => setIsCollapsed(!isCollapsed)}
                            >
                                {isCollapsed ? <ChevronRight size={16} /> : <ChevronDown size={16} />}
                            </div>
                            <h3 className="text-[14px] font-bold text-foreground whitespace-nowrap overflow-hidden text-ellipsis max-w-[400px]">
                                {title}
                            </h3>
                            <div className="flex items-center space-x-2 ml-2">
                                <div 
                                    className={cn(
                                        "flex items-center space-x-1 text-xs px-2 py-0.5 rounded-md cursor-pointer select-none transition-colors",
                                        viewMode === 'cumulative' 
                                            ? "bg-teal-50 text-teal-600 border border-teal-200/50" 
                                            : "bg-amber-50 text-amber-700 border border-amber-200/50"
                                    )}
                                    onClick={() => setViewMode(viewMode === 'cumulative' ? 'daily' : 'cumulative')}
                                >
                                    {viewMode === 'cumulative' ? null : <Clock size={12} />}
                                    <span>{viewMode === 'cumulative' ? 'ä»å¤´ç´¯è®¡' : 'åˆ†å¤©å¹³å‡'}</span>
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center space-x-2 text-xs text-muted-foreground">
                            {/* Large Screen View */}
                            <div className="hidden min-[1500px]:flex items-center space-x-2">
                                <ConfigBadge 
                                    label="æ•°æ®å£å¾„" 
                                    value={config.metricType} 
                                    options={['CUPED', 'CUPED+', 'åŸå§‹å€¼']} 
                                    onSelect={(v) => setConfig({...config, metricType: v})} 
                                />
                                <div className="w-[1px] h-3 bg-border"></div>
                                <ConfigBadge 
                                    label="æ˜¾è‘—æ€§æ°´å¹³" 
                                    value={config.significanceLevel} 
                                    options={['1%', '5%', '10%']} 
                                    onSelect={(v) => setConfig({...config, significanceLevel: v})} 
                                />
                                <div className="w-[1px] h-3 bg-border"></div>
                                <ConfigBadge 
                                    label="å¤šé‡æ¯”è¾ƒä¿®æ­£" 
                                    value={config.multiCorrection} 
                                    options={['å¼€', 'å…³']} 
                                    onSelect={(v) => setConfig({...config, multiCorrection: v})} 
                                />
                            </div>

                            {/* Small Screen View */}
                            <div className="flex min-[1500px]:hidden relative items-center" ref={configMenuRef}>
                                <ConfigBadge 
                                    label="æ•°æ®å£å¾„" 
                                    value={config.metricType} 
                                    options={['CUPED', 'CUPED+', 'åŸå§‹å€¼']} 
                                    onSelect={(v) => setConfig({...config, metricType: v})} 
                                />
                                <div className="w-[1px] h-3 bg-border mx-2"></div>
                                <Button 
                                    variant="ghost" 
                                    size="icon" 
                                    className="h-6 w-6 text-muted-foreground hover:text-foreground" 
                                    onClick={() => setIsConfigMenuOpen(!isConfigMenuOpen)}
                                >
                                     <MoreHorizontal size={14}/>
                                </Button>
                                {isConfigMenuOpen && (
                                    <div className="absolute right-0 top-full mt-2 p-4 bg-background border rounded-lg shadow-lg z-[60] flex flex-col space-y-3 min-w-[200px] animate-in fade-in zoom-in-95 duration-200">
                                        <div className="flex justify-between items-center">
                                            <ConfigBadge 
                                                label="æ˜¾è‘—æ€§æ°´å¹³" 
                                                value={config.significanceLevel} 
                                                options={['1%', '5%', '10%']} 
                                                onSelect={(v) => setConfig({...config, significanceLevel: v})} 
                                            />
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <ConfigBadge 
                                                label="å¤šé‡æ¯”è¾ƒä¿®æ­£" 
                                                value={config.multiCorrection} 
                                                options={['å¼€', 'å…³']} 
                                                onSelect={(v) => setConfig({...config, multiCorrection: v})} 
                                            />
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            <div className="w-[1px] h-3 bg-border mx-2"></div>
                            <Button 
                                 variant="outline" 
                                 size="icon" 
                                 className="h-7 w-7 "
                                 title="AI è§£è¯»"
                                 onClick={() => onTriggerAIAnalysis()}
                             >
                                 <img src="assets/images/icon/AIstar.svg" className="w-4 h-4" />
                             </Button>
                        </div>
                    </div>
                    
                    {!isCollapsed && (
                        <>
                            <Table>
                                <TableHeader className="sticky top-0 z-10">
                                    <TableRow className="bg-[#F7F8F9] hover:bg-[#F7F8F9]">
                                        <TableHead className="whitespace-nowrap sticky left-0 z-20 text-[13px] bg-[#F7F8F9]">å®éªŒåˆ†ç»„</TableHead>
                                        {columns.map(col => (
                                        <TableHead 
                                            key={col.id} 
                                            className="w-[200px] text-right border-r border-border/50 text-[13px] relative group/head"
                                            onMouseEnter={() => setHoveredColId(col.id)}
                                            onMouseLeave={() => setHoveredColId(null)}
                                        >
                                            {hoveredColId === col.id && (
                                                 <div className="absolute left-2 top-1/2 -translate-y-1/2 z-30">
                                                    <Button variant="ghost" size="icon" className="h-6 w-6 bg-background hover:bg-gray-50 rounded-md shadow-sm border" onClick={() => onTriggerAIAnalysis(col.label)}>
                                                        <img src="assets/images/icon/AIstar.svg" className="w-3.5 h-3.5" />
                                                    </Button>
                                                 </div>
                                            )}
                                            <div className="flex items-center justify-end space-x-1 cursor-pointer group">
                                                <span>{col.label}</span>
                                            </div>
                                        </TableHead>
                                    ))}
                                    </TableRow>
                                </TableHeader>
                                <TableBody>
                                    {data.map((group, idx) => (
                                        <TableRow key={group.id} className={idx === 0 ? 'bg-background' : 'bg-background'}>
                                            <TableCell className="whitespace-nowrap align-middle sticky left-0 z-[5] bg-background border-r border-border/50">
                                                <div className="flex items-center space-x-2">
                                                    <div className="font-[13px] text-foreground">{group.name}</div>
                                                    {group.isControl && <Badge variant="secondary" className="text-[10px] h-5 px-1.5 font-normal text-muted-foreground whitespace-nowrap">å¯¹ç…§ç»„</Badge>}
                                                </div>
                                            </TableCell>
                                            {columns.map(col => {
                                                const metric = group.metrics[col.id];
                                                if (!metric) return <TableCell key={col.id} className="text-right border-r border-border/50">-</TableCell>;

                                                let bgClass = "";
                                                let textClass = "text-foreground";

                                                if (!group.isControl) {
                                                    if (metric.deltaType === 'positive') {
                                                        bgClass = metric.significance === 'positive' ? "bg-green-50/50" : "";
                                                        textClass = "text-green-600";
                                                    } else if (metric.deltaType === 'negative') {
                                                        bgClass = metric.significance === 'negative' ? "bg-red-50/50" : "";
                                                        textClass = "text-red-600";
                                                    }
                                                }

                                                return (
                                                    <TableCell 
                                                        key={col.id} 
                                                        className={cn("text-right align-top relative group/cell border-r border-border/50", bgClass)}
                                                        onMouseEnter={() => setHoveredColId(col.id)}
                                                        onMouseLeave={() => setHoveredColId(null)}
                                                    >
                                                        {group.isControl ? (
                                                             <div className="text-foreground font-[13px] font-bold tabular-nums tracking-tight">{metric.value}</div>
                                                        ) : (
                                                             <>
                                                                {(metric.significance === 'positive' || metric.significance === 'negative') && (
                                                                    <div className={cn(
                                                                        "absolute left-1 top-1 px-1 rounded text-[12px] font-medium opacity-0 group-hover/cell:opacity-100 transition-opacity pointer-events-none select-none",
                                                                        metric.significance === 'positive' ? "bg-green-600 text-white" : "bg-red-600 text-white"
                                                                    )}>
                                                                        {metric.significance === 'positive' ? 'æ­£å‘æ˜¾è‘—' : 'è´Ÿå‘æ˜¾è‘—'}
                                                                    </div>
                                                                )}
                                                                 <div className="flex flex-col items-end space-y-0.5">
                                                                    <div className={cn("text-[18px] font-bold tabular-nums", textClass)}>
                                                                        {metric.delta}
                                                                    </div>
                                                                    <div className="text-[13px] font-bold text-gray-700 tabular-nums">
                                                                        {metric.confidenceInterval || '-'}
                                                                    </div>
                                                                    <div className="text-gray-400 font-normal text-[13px] tabular-nums tracking-tight">
                                                                        {metric.value}
                                                                    </div>
                                                                 </div>
                                                             </>
                                                        )}
                                                    </TableCell>
                                                );
                                            })}
                                        </TableRow>
                                    ))}
                                </TableBody>
                            </Table>
                            <div className="text-center py-2 bg-white border-t cursor-pointer hover:bg-muted/20 transition-colors flex items-center justify-center space-x-1 text-muted-foreground hover:text-foreground">
                                 <Plus size={16} />
                                 <span className="text-xs font-medium">æŒ‡æ ‡è¶‹åŠ¿</span>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const DividerBlock = ({ level, title, onUpdateLevel, onUpdateTitle, isCollapsed, onToggleCollapse }) => {
            const [showMenu, setShowMenu] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [tempTitle, setTempTitle] = useState(title);
            const menuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setShowMenu(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, []);

            const handleLevelSelect = (newLevel) => {
                onUpdateLevel(newLevel);
                setShowMenu(false);
            };

            const handleTitleSave = () => {
                onUpdateTitle(tempTitle);
                setIsEditing(false);
            };

            const getTitleStyle = (lvl) => {
                switch (lvl) {
                    case 'ä¸€çº§': return 'text-[14px] font-medium text-foreground';
                    case 'äºŒçº§': return 'text-[13px] font-medium text-foreground';
                    case 'ä¸‰çº§': return 'text-[13px] font-medium text-foreground';
                    default: return 'text-[13px] font-medium text-foreground';
                }
            };

            return (
                <div className="flex items-center space-x-2 mt-4 group">
                    <div 
                        className="cursor-pointer text-muted-foreground hover:text-foreground transition-colors p-0.5 rounded hover:bg-muted flex items-center justify-center"
                        onClick={onToggleCollapse}
                    >
                        {isCollapsed ? <ChevronRight size={16} /> : <ChevronDown size={16} />}
                    </div>

                     {isEditing ? (
                        <input 
                            value={tempTitle}
                            onChange={(e) => setTempTitle(e.target.value)}
                            onBlur={handleTitleSave}
                            onKeyDown={(e) => e.key === 'Enter' && handleTitleSave()}
                            className={cn(getTitleStyle(level), "bg-transparent border-b border-primary outline-none")}
                            autoFocus
                        />
                     ) : (
                        <span 
                            className={cn(getTitleStyle(level), "cursor-text hover:bg-muted/30 rounded px-1 -ml-1 transition-colors")}
                            onDoubleClick={() => setIsEditing(true)}
                        >
                            {title}
                        </span>
                     )}

                    <div className="relative opacity-0 group-hover:opacity-100 transition-opacity" ref={menuRef}>
                         <div 
                            className="bg-muted text-muted-foreground px-2 py-0.5 rounded text-xs cursor-pointer hover:bg-muted/80 relative select-none"
                            onClick={() => setShowMenu(!showMenu)}
                         >
                            {level}
                         </div>
                         {showMenu && (
                             <div className="absolute top-full left-0 mt-1 bg-background border rounded-md shadow-lg z-[100] w-20 py-1 flex flex-col">
                                 {['ä¸€çº§', 'äºŒçº§', 'ä¸‰çº§'].map((l) => (
                                     <div 
                                        key={l} 
                                        className="text-sm px-3 py-1.5 hover:bg-muted cursor-pointer text-foreground"
                                        onClick={() => handleLevelSelect(l)}
                                     >
                                         {l}
                                     </div>
                                 ))}
                             </div>
                         )}
                    </div>

                    {!isEditing && (
                        <Button 
                            variant="ghost" 
                            size="icon" 
                            className="h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity text-muted-foreground hover:text-primary"
                            onClick={() => setIsEditing(true)}
                        >
                            <Pencil size={12} />
                        </Button>
                    )}
                </div>
            );
        };

        const AnalysisCardBlock = ({ title, metricType, groupName = 'ç”Ÿæ´»æœåŠ¡-ç›´æ’­ç”¨æˆ·æ ¸å¿ƒæŒ‡æ ‡', dimensionName = 'room_type (ç›´æ’­é—´ç±»å‹)' }) => {
            const [isCollapsed, setIsCollapsed] = useState(false);
            const [viewMode, setViewMode] = useState('cumulative');
            const [config, setConfig] = useState({
                metricType: 'CUPED',
                significanceLevel: '5%',
                multiCorrection: 'å¼€',
                dimCorrection: 'å…³'
            });
            const [isConfigMenuOpen, setIsConfigMenuOpen] = useState(false);
            const configMenuRef = useRef(null);

            // Construct display title from props
            const displayTitle = `${groupName} â†’ ${dimensionName}`;
            const columns = [
                { id: 'm1', label: 'ç›´æ’­GMV' },
                { id: 'm2', label: 'åƒæ¬¡è§‚çœ‹æˆäº¤' },
                { id: 'm3', label: 'äººå‡è§‚çœ‹æ—¶é•¿' },
                { id: 'm4', label: 'ç”¨æˆ·ç•™å­˜ç‡' },
                { id: 'm5', label: 'ç‚¹å‡»è½¬åŒ–ç‡' },
                { id: 'm6', label: 'äº’åŠ¨è¯„è®ºæ•°' },
                { id: 'm7', label: 'æ–°å¢ç²‰ä¸æ•°' },
                { id: 'm8', label: 'é€€è´§ç‡' },
            ];
            
            // Generate data for each dimension
            const generateGroupData = (dimSuffix) => [
                { 
                    id: `g0_${dimSuffix}`, 
                    name: 'å¯¹ç…§ç»„ (V0)', 
                    isControl: true,
                    metrics: {
                        m1: { value: '119.1ä¸‡' },
                        m2: { value: '873.6' },
                        m3: { value: '45.5s' },
                        m4: { value: '41.3%' },
                        m5: { value: '2.8%' },
                        m6: { value: '11,475' },
                        m7: { value: '3,110' },
                        m8: { value: '5.3%' },
                    }
                },
                { 
                    id: `g1_${dimSuffix}`, 
                    name: 'å®éªŒç»„1 (V1)', 
                    isControl: false,
                    metrics: {
                        m1: { value: '125.4ä¸‡', delta: '+5.2312%', confidenceInterval: 'Â±0.1456%', significance: 'positive', deltaType: 'positive' }, // æ˜¾è‘—
                        m2: { value: '892.1', delta: '+2.1145%', confidenceInterval: 'Â±2.8923%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m3: { value: '45s', delta: '-1.2134%', confidenceInterval: 'Â±3.0567%', significance: 'neutral', deltaType: 'negative' }, // ä¸æ˜¾è‘—
                        m4: { value: '42.8%', delta: '+1.5678%', confidenceInterval: 'Â±2.1122%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m5: { value: '3.2%', delta: '+0.4321%', confidenceInterval: 'Â±0.9234%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m6: { value: '12,450', delta: '+8.5432%', confidenceInterval: 'Â±10.3456%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m7: { value: '3,210', delta: '+3.2109%', confidenceInterval: 'Â±4.1234%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m8: { value: '5.1%', delta: '-0.2345%', confidenceInterval: 'Â±0.8123%', significance: 'neutral', deltaType: 'neutral' }, // ä¸æ˜¾è‘—
                    }
                },
                { 
                    id: `g2_${dimSuffix}`, 
                    name: 'å®éªŒç»„2 (V2)', 
                    isControl: false,
                    metrics: {
                        m1: { value: '126.8ä¸‡', delta: '+6.4523%', confidenceInterval: 'Â±7.1567%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m2: { value: '895.4', delta: '+2.4987%', confidenceInterval: 'Â±3.0987%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m3: { value: '45.2s', delta: '-0.6543%', confidenceInterval: 'Â±1.0654%', significance: 'neutral', deltaType: 'negative' }, // ä¸æ˜¾è‘—
                        m4: { value: '43.1%', delta: '+2.1234%', confidenceInterval: 'Â±0.1234%', significance: 'positive', deltaType: 'positive' }, // æ˜¾è‘—
                        m5: { value: '3.3%', delta: '+0.6789%', confidenceInterval: 'Â±1.0345%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m6: { value: '12,890', delta: '+12.3456%', confidenceInterval: 'Â±15.4567%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m7: { value: '3,340', delta: '+7.3912%', confidenceInterval: 'Â±8.2345%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m8: { value: '5.2%', delta: '-0.1876%', confidenceInterval: 'Â±0.5234%', significance: 'neutral', deltaType: 'neutral' }, // ä¸æ˜¾è‘—
                    }
                },
                { 
                    id: `g3_${dimSuffix}`, 
                    name: 'å®éªŒç»„3 (V3)', 
                    isControl: false,
                    metrics: {
                        m1: { value: '123.9ä¸‡', delta: '+4.0321%', confidenceInterval: 'Â±5.1345%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m2: { value: '885.2', delta: '+1.3210%', confidenceInterval: 'Â±2.0876%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m3: { value: '46.1s', delta: '+1.3188%', confidenceInterval: 'Â±1.9765%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m4: { value: '42.2%', delta: '+0.9876%', confidenceInterval: 'Â±1.1098%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m5: { value: '3.0%', delta: '+0.2109%', confidenceInterval: 'Â±0.5123%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m6: { value: '11,980', delta: '+4.4005%', confidenceInterval: 'Â±5.2345%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                        m7: { value: '3,150', delta: '+1.2863%', confidenceInterval: 'Â±0.1122%', significance: 'positive', deltaType: 'positive' }, // æ˜¾è‘—
                        m8: { value: '5.4%', delta: '+0.1876%', confidenceInterval: 'Â±0.6345%', significance: 'neutral', deltaType: 'positive' }, // ä¸æ˜¾è‘—
                    }
                }
            ];

            const data = {
                'type=1': generateGroupData('t1'),
                'type=2': generateGroupData('t2')
            };

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (configMenuRef.current && !configMenuRef.current.contains(event.target)) {
                        setIsConfigMenuOpen(false);
                    }
                };
                if (isConfigMenuOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isConfigMenuOpen]);

            return (
                <div className="overflow-hidden bg-white">
                    <div className={cn("px-4 border-b bg-white flex justify-between items-center py-3 h-[52px]")}>
                        <div className="flex items-center space-x-3">
                            <div 
                                className="cursor-pointer text-muted-foreground hover:text-foreground transition-colors mr-1"
                                onClick={() => setIsCollapsed(!isCollapsed)}
                            >
                                {isCollapsed ? <ChevronRight size={16} /> : <ChevronDown size={16} />}
                            </div>
                            <h3 className="text-[14px] font-bold text-foreground whitespace-nowrap overflow-hidden text-ellipsis max-w-[400px]">
                                {displayTitle}
                            </h3>
                            <div className="flex items-center space-x-2 ml-2">
                                <div 
                                    className={cn(
                                        "flex items-center space-x-1 text-xs px-2 py-0.5 rounded-md cursor-pointer select-none transition-colors",
                                        viewMode === 'cumulative' 
                                            ? "bg-teal-50 text-teal-600 border border-teal-200/50" 
                                            : "bg-amber-50 text-amber-700 border border-amber-200/50"
                                    )}
                                    onClick={() => setViewMode(viewMode === 'cumulative' ? 'daily' : 'cumulative')}
                                >
                                    {viewMode === 'cumulative' ? null : <Clock size={12} />}
                                    <span>{viewMode === 'cumulative' ? 'ä»å¤´ç´¯è®¡' : 'åˆ†å¤©å¹³å‡'}</span>
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center space-x-2 text-xs text-muted-foreground">
                            {/* Large Screen View */}
                            <div className="hidden min-[1500px]:flex items-center space-x-2">
                                <ConfigBadge 
                                    label="æ•°æ®å£å¾„" 
                                    value={config.metricType} 
                                    options={['CUPED', 'CUPED+', 'åŸå§‹å€¼']} 
                                    onSelect={(v) => setConfig({...config, metricType: v})} 
                                />
                                <div className="w-[1px] h-3 bg-border"></div>
                                <ConfigBadge 
                                    label="æ˜¾è‘—æ€§æ°´å¹³" 
                                    value={config.significanceLevel} 
                                    options={['1%', '5%', '10%']} 
                                    onSelect={(v) => setConfig({...config, significanceLevel: v})} 
                                />
                                <div className="w-[1px] h-3 bg-border"></div>
                                <ConfigBadge 
                                    label="å¤šé‡æ¯”è¾ƒä¿®æ­£" 
                                    value={config.multiCorrection} 
                                    options={['å¼€', 'å…³']} 
                                    onSelect={(v) => setConfig({...config, multiCorrection: v})} 
                                />
                            </div>

                            {/* Small Screen View */}
                            <div className="flex min-[1500px]:hidden relative items-center" ref={configMenuRef}>
                                <ConfigBadge 
                                    label="æ•°æ®å£å¾„" 
                                    value={config.metricType} 
                                    options={['CUPED', 'CUPED+', 'åŸå§‹å€¼']} 
                                    onSelect={(v) => setConfig({...config, metricType: v})} 
                                />
                                <div className="w-[1px] h-3 bg-border mx-2"></div>
                                <Button 
                                    variant="ghost" 
                                    size="icon" 
                                    className="h-6 w-6 text-muted-foreground hover:text-foreground" 
                                    onClick={() => setIsConfigMenuOpen(!isConfigMenuOpen)}
                                >
                                     <MoreHorizontal size={14}/>
                                </Button>
                                {isConfigMenuOpen && (
                                    <div className="absolute right-0 top-full mt-2 p-4 bg-background border rounded-lg shadow-lg z-[60] flex flex-col space-y-3 min-w-[200px] animate-in fade-in zoom-in-95 duration-200">
                                        <div className="flex justify-between items-center">
                                            <ConfigBadge 
                                                label="æ˜¾è‘—æ€§æ°´å¹³" 
                                                value={config.significanceLevel} 
                                                options={['1%', '5%', '10%']} 
                                                onSelect={(v) => setConfig({...config, significanceLevel: v})} 
                                            />
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <ConfigBadge 
                                                label="å¤šé‡æ¯”è¾ƒä¿®æ­£" 
                                                value={config.multiCorrection} 
                                                options={['å¼€', 'å…³']} 
                                                onSelect={(v) => setConfig({...config, multiCorrection: v})} 
                                            />
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {!isCollapsed && (
                        <>
                            <Table>
                                <TableHeader className="sticky top-0 z-10">
                                    <TableRow className="bg-[#F7F8F9] hover:bg-[#F7F8F9]">
                                        <TableHead className="whitespace-nowrap sticky left-0 z-20 text-[13px] bg-[#F7F8F9] w-[160px] min-w-[160px] border-r border-border/50">room_type (ç›´æ’­é—´ç±»å‹)</TableHead>
                                        <TableHead className="whitespace-nowrap sticky left-[160px] z-20 text-[13px] bg-[#F7F8F9] border-r border-border/50 w-[180px] min-w-[180px]">å®éªŒåˆ†ç»„</TableHead>
                                        {columns.map(col => (
                                            <TableHead key={col.id} className="w-[200px] min-w-[200px] text-right border-r border-border/50 text-[13px]">
                                                <div className="flex items-center justify-end space-x-1 cursor-pointer group">
                                                    <span>{col.label}</span>
                                                </div>
                                            </TableHead>
                                        ))}
                                    </TableRow>
                                </TableHeader>
                                <TableBody>
                                    {Object.entries(data).map(([dim, groups]) => (
                                        <React.Fragment key={dim}>
                                            {groups.map((group, idx) => (
                                                <TableRow key={group.id} className="bg-background">
                                                    {idx === 0 && (
                                                        <TableCell rowSpan={groups.length} className="whitespace-nowrap align-top sticky left-0 z-[5] bg-background border-r border-border/50 font-medium text-[13px] text-foreground p-4 w-[160px] min-w-[160px]">
                                                            {dim}
                                                        </TableCell>
                                                    )}
                                                    <TableCell className="whitespace-nowrap align-middle sticky left-[160px] z-[5] bg-background border-r border-border/50 w-[180px] min-w-[180px]">
                                                        <div className="flex items-center space-x-2">
                                                            <div className="font-[13px] text-foreground">{group.name}</div>
                                                            {group.isControl && <Badge variant="secondary" className="text-[10px] h-5 px-1.5 font-normal text-muted-foreground whitespace-nowrap">å¯¹ç…§ç»„</Badge>}
                                                        </div>
                                                    </TableCell>
                                                    {columns.map(col => {
                                                        const metric = group.metrics[col.id];
                                                        if (!metric) return <TableCell key={col.id} className="text-right border-r border-border/50">-</TableCell>;

                                                        let bgClass = "";
                                                        let textClass = "text-foreground";

                                                        if (!group.isControl) {
                                                            if (metric.deltaType === 'positive') {
                                                                bgClass = metric.significance === 'positive' ? "bg-green-50/50" : "";
                                                                textClass = "text-green-600";
                                                            } else if (metric.deltaType === 'negative') {
                                                                bgClass = metric.significance === 'negative' ? "bg-red-50/50" : "";
                                                                textClass = "text-red-600";
                                                            }
                                                        }

                                                        return (
                                                            <TableCell key={col.id} className={cn("text-right align-top relative group/cell border-r border-border/50", bgClass)}>
                                                                {group.isControl ? (
                                                                     <div className="text-foreground font-[13px] font-bold tabular-nums tracking-tight">{metric.value}</div>
                                                                ) : (
                                                                     <>
                                                                         {(metric.significance === 'positive' || metric.significance === 'negative') && (
                                                                             <div className={cn(
                                                                                 "absolute left-1 top-1 px-1 rounded text-[12px] font-medium opacity-0 group-hover/cell:opacity-100 transition-opacity pointer-events-none select-none",
                                                                                 metric.significance === 'positive' ? "bg-green-600 text-white" : "bg-red-600 text-white"
                                                                             )}>
                                                                                 {metric.significance === 'positive' ? 'æ­£å‘æ˜¾è‘—' : 'è´Ÿå‘æ˜¾è‘—'}
                                                                             </div>
                                                                         )}
                                                                         <div className="flex flex-col items-end space-y-0.5">
                                                                            <div className={cn("text-[18px] font-bold tabular-nums", textClass)}>
                                                                                {metric.delta}
                                                                            </div>
                                                                            <div className="text-[13px] font-bold text-gray-700 tabular-nums">
                                                                                {metric.confidenceInterval || '-'}
                                                                            </div>
                                                                            <div className="text-gray-400 font-normal text-[13px] tabular-nums tracking-tight">
                                                                                {metric.value}
                                                                            </div>
                                                                         </div>
                                                                     </>
                                                                )}
                                                            </TableCell>
                                                        );
                                                    })}
                                                </TableRow>
                                            ))}
                                        </React.Fragment>
                                    ))}
                                </TableBody>
                            </Table>
                            <div className="text-center py-2 bg-white border-t cursor-pointer hover:bg-muted/20 transition-colors flex items-center justify-center space-x-1 text-muted-foreground hover:text-foreground">
                                 <Plus size={16} />
                                 <span className="text-xs font-medium">æŒ‡æ ‡è¶‹åŠ¿</span>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const ALL_METRICS = [
            { id: 'm1', label: 'GMV', type: 'metric' },
            { id: 'm2', label: 'è®¢å•é‡', type: 'metric' },
            { id: 'm3', label: 'ç”¨æˆ·æ•°', type: 'metric' },
            { id: 'm4', label: 'äººå‡æ—¶é•¿', type: 'metric' },
            { id: 'm5', label: 'æ¬¡æ—¥ç•™å­˜', type: 'metric' },
            { id: 'd1', label: 'åŸå¸‚', type: 'dimension' },
            { id: 'd2', label: 'çœä»½', type: 'dimension' },
            { id: 'd3', label: 'æ“ä½œç³»ç»Ÿ', type: 'dimension' },
            { id: 'd4', label: 'APPç‰ˆæœ¬', type: 'dimension' },
        ];

        const Tabs = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground", className)} {...props} />
        ));
        Tabs.displayName = "Tabs";

        const TabsList = React.forwardRef(({ className, ...props }, ref) => (
            <div ref={ref} className={cn("inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground", className)} {...props} />
        ));
        TabsList.displayName = "TabsList";

        const TabsTrigger = React.forwardRef(({ className, isActive, ...props }, ref) => (
            <button
                ref={ref}
                className={cn(
                    "inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",
                    isActive ? "bg-background text-foreground shadow" : "hover:bg-background/50 hover:text-foreground",
                    className
                )}
                {...props}
            />
        ));
        TabsTrigger.displayName = "TabsTrigger";

        const MentionList = React.forwardRef((props, ref) => {
            const [selectedIndex, setSelectedIndex] = useState(0);
            const [activeTab, setActiveTab] = useState('current'); // 'current' | 'all'

            const selectItem = index => {
                const item = displayedItems[index];
                if (item) {
                    props.command({ id: item.id, label: item.label, type: item.type });
                }
            };

            // Filter items based on active tab
            const displayedItems = props.items.filter(item => {
                if (activeTab === 'current') {
                    return item.source === 'current';
                } else {
                    return item.source === 'all';
                }
            });

            const upHandler = () => {
                if (displayedItems.length === 0) return;
                setSelectedIndex((selectedIndex + displayedItems.length - 1) % displayedItems.length);
            };

            const downHandler = () => {
                if (displayedItems.length === 0) return;
                setSelectedIndex((selectedIndex + 1) % displayedItems.length);
            };

            const enterHandler = () => {
                selectItem(selectedIndex);
            };

            useEffect(() => setSelectedIndex(0), [displayedItems]);

            // Auto-switch tab if current view is empty but other has results
            useEffect(() => {
                const currentCount = props.items.filter(i => i.source === 'current').length;
                const allCount = props.items.filter(i => i.source === 'all').length;

                if (activeTab === 'current' && currentCount === 0 && allCount > 0) {
                    setActiveTab('all');
                } else if (activeTab === 'all' && allCount === 0 && currentCount > 0) {
                    setActiveTab('current');
                }
            }, [props.items]);

            useImperativeHandle(ref, () => ({
                onKeyDown: ({ event }) => {
                    if (event.key === 'ArrowUp') {
                        upHandler();
                        return true;
                    }
                    if (event.key === 'ArrowDown') {
                        downHandler();
                        return true;
                    }
                    if (event.key === 'Enter') {
                        enterHandler();
                        return true;
                    }
                    return false;
                },
            }));

            const currentCount = props.items.filter(i => i.source === 'current').length;
            const allCount = props.items.filter(i => i.source === 'all').length;

            return (
                <div className="bg-background border rounded-lg shadow-lg overflow-hidden min-w-[240px] z-[9999] bg-white flex flex-col p-1">
                    <TabsList className="w-full grid grid-cols-2 mb-1">
                        <TabsTrigger 
                            isActive={activeTab === 'current'}
                            onClick={() => setActiveTab('current')}
                            className="text-xs h-7"
                        >
                            å½“å‰é¡µé¢ ({currentCount})
                        </TabsTrigger>
                        <TabsTrigger 
                            isActive={activeTab === 'all'}
                            onClick={() => setActiveTab('all')}
                            className="text-xs h-7"
                        >
                            å…¨éƒ¨ ({allCount})
                        </TabsTrigger>
                    </TabsList>
                    
                    <div className="p-1 max-h-[200px] overflow-y-auto">
                        {displayedItems.length ? (
                            displayedItems.map((item, index) => (
                                <div
                                    key={`${item.source}-${item.id}`}
                                    className={cn(
                                        "flex items-center px-2 py-1.5 text-xs cursor-pointer rounded-md",
                                        index === selectedIndex ? "bg-accent text-accent-foreground bg-gray-100" : "text-muted-foreground hover:bg-accent hover:text-accent-foreground"
                                    )}
                                    onClick={() => selectItem(index)}
                                >
                                    {item.type === 'metric' && <img src="assets/images/icon/Chart.svg" width="12" height="12" alt="Chart" className="mr-2 shrink-0" />}
                                    {item.type === 'dimension' && <img src="assets/images/icon/dimension.svg" className="w-3 h-3 mr-2 text-purple-500 shrink-0" />}
                                    {item.type === 'dashboard' && <img src="assets/images/icon/folder.svg" width="12" height="12" alt="folder" className="mr-2 shrink-0" />}
                                    {item.type === 'analysis_card' && <img src="assets/images/icon/DrillDown.svg" width="12" height="12" alt="DrillDown" className="mr-2 shrink-0" />}
                                    {item.type === 'ask_ai' && <Sparkles size={12} className="mr-2 text-indigo-500 shrink-0" />}
                                    <span className="truncate">{item.label}</span>
                                </div>
                            ))
                        ) : (
                            <div className="px-2 py-4 text-xs text-muted-foreground text-center">æš‚æ— å†…å®¹</div>
                        )}
                    </div>
                </div>
            );
        });

        // Custom Mention Extension to support 'type' attribute for icon styling
        const CustomMention = Mention.extend({
            addAttributes() {
                return {
                    id: {
                        default: null,
                        parseHTML: element => element.getAttribute('data-id'),
                        renderHTML: attributes => {
                            return {
                                'data-id': attributes.id,
                            }
                        },
                    },
                    label: {
                        default: null,
                        parseHTML: element => element.getAttribute('data-label'),
                        renderHTML: attributes => {
                            return {
                                'data-label': attributes.label,
                            }
                        },
                    },
                    type: {
                        default: 'metric',
                        parseHTML: element => element.getAttribute('data-type'),
                        renderHTML: attributes => {
                            return {
                                'data-type': attributes.type,
                            }
                        },
                    },
                }
            },
        });

        const AIResultCard = ({ query, executionContent, resultContent, isStreamFinished, isExecutionFinished, onClose, onRefresh }) => {
            const [isExpanded, setIsExpanded] = useState(true);

            useEffect(() => {
                if (isExecutionFinished) {
                    setIsExpanded(false);
                }
            }, [isExecutionFinished]);

            return (
                <div className="border border-gray-200 rounded-xl bg-white p-4 shadow-sm relative animate-in fade-in zoom-in-95 duration-300 hover:border-primary/50">
                    <div className="absolute top-2 right-2 flex items-center space-x-1">
                         <Button variant="ghost" size="icon" className="h-6 w-6 text-gray-400 hover:text-gray-600" onClick={onRefresh}>
                            <RefreshCw size={14} />
                         </Button>
                         <Button variant="ghost" size="icon" className="h-6 w-6 text-gray-400 hover:text-gray-600" onClick={onClose}>
                            <span className="text-lg">Ã—</span>
                         </Button>
                    </div>

                    {/* Query Header */}
                    <div className="flex items-center text-gray-500 text-xs mb-3 pr-16">
                        <img src="assets/images/icon/quote.svg" className="mr-2 w-3.5 h-3.5 opacity-50" />
                        <span>{query}</span>
                    </div>

                    {/* Execution Process */}
                    <div className="bg-gray-50 rounded-lg p-3 mb-3">
                        <div 
                            className="flex justify-between items-center cursor-pointer select-none"
                            onClick={() => setIsExpanded(!isExpanded)}
                        >
                            <div className="flex items-center space-x-2">
                                <Sparkles size={14} className="text-indigo-500" />
                                <span className="text-xs font-bold text-gray-700">
                                    {isStreamFinished ? "æ‰§è¡Œå®Œæˆ" : "æ­£åœ¨æ€è€ƒ..."}
                                </span>
                            </div>
                            {isExpanded ? <ChevronDown size={14} className="text-gray-400" /> : <ChevronRight size={14} className="text-gray-400" />}
                        </div>
                        
                        {isExpanded && (
                            <div className="text-xs text-gray-500 leading-relaxed mt-2 pl-6 border-l-2 border-indigo-100 ml-1.5 space-y-2 whitespace-pre-wrap font-mono">
                                {executionContent || <span className="animate-pulse">...</span>}
                            </div>
                        )}
                    </div>

                    {/* Analysis Result */}
                    <div className="text-[13px] text-gray-800 leading-relaxed pl-1 whitespace-pre-wrap">
                        {resultContent ? (
                            <span dangerouslySetInnerHTML={{ __html: resultContent }}></span>
                        ) : (
                            <div className="flex items-center space-x-1 text-gray-400">
                                <span className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span>
                                <span className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-75"></span>
                                <span className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-150"></span>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const AskAIBlock = ({ sections }) => {
             const sectionsRef = useRef(sections);
             // Always keep ref up to date synchronously during render
             sectionsRef.current = sections;
             
             const [analysisState, setAnalysisState] = useState('idle'); // idle, analyzing, done
             const [isExecutionFinished, setIsExecutionFinished] = useState(false);
             const [streamData, setStreamData] = useState({ query: '', execution: '', result: '' });
             const [hasContent, setHasContent] = useState(false);

             const handleAnalyze = () => {
                 if (!editor || editor.isEmpty) return;
                 
                 const queryText = editor.getText();
                 setStreamData({ query: queryText, execution: '', result: '' });
                 setAnalysisState('analyzing');
                 setIsExecutionFinished(false);
                 
                 // Simulate Streaming
                 const executionText = `é¦–å…ˆï¼Œå›é¡¾PRDä¸­çš„å®éªŒèƒŒæ™¯ã€‚è¿™ä¸ªå®éªŒçš„ç›®æ ‡æ˜¯åœ¨ç”Ÿæœç›´æ’­é—´è´­ç‰©è¢‹å¼¹å‡ºæ—¶ï¼Œè°ƒæ•´ç›´æ’­ç”»é¢çš„è‡ªé€‚åº”å¤„ç†ï¼Œç¡®ä¿ç”¨æˆ·èƒ½çœ‹åˆ°ç”»é¢ä¸»ä½“ï¼Œæ¯”å¦‚äººåƒã€‚é¢„æœŸæ˜¯æå‡äº¤æ˜“æŒ‡æ ‡ï¼Œå¦‚GMVå’Œè®¢å•é‡ã€‚å®éªŒç»„ç›¸æ¯”å¯¹ç…§ç»„ï¼Œé™¤äº†è‡ªé€‚åº”è°ƒæ•´ï¼Œè¿˜å–æ¶ˆäº†è’™å±‚ã€‚å› æ­¤ï¼Œå¯èƒ½çš„å½±å“è·¯å¾„æ˜¯ç”¨æˆ·æ›´å®¹æ˜“åŒæ—¶è§‚çœ‹ç›´æ’­å†…å®¹å’Œè´­ç‰©è¢‹å•†å“ï¼Œä»è€Œä¿ƒè¿›è´­ä¹°ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦æ‹†è§£è¿™ä¸ªæå‡çš„å¯èƒ½è·¯å¾„ã€‚æ ¹æ®PRDä¸­çš„ç­–ç•¥ï¼Œè´­ç‰©è¢‹å¼¹å‡ºæ—¶ç”»é¢è‡ªé€‚åº”ï¼Œå¯èƒ½å½±å“ç”¨æˆ·å¯¹å•†å“çš„å…³æ³¨å’Œç‚¹å‡»ï¼Œè¿›è€Œå½±å“è½¬åŒ–ã€‚æ‰€ä»¥ï¼Œå¯èƒ½éœ€è¦åˆ†æè´­ç‰©è¢‹ç›¸å…³æŒ‡æ ‡å’Œç”¨æˆ·äº’åŠ¨è¡Œä¸ºçš„å˜åŒ–ã€‚`;
                 
                 const resultText = `è´§æ¶ç‚¹å‡»æ¸—é€ç‡æ˜¾è‘—ä¸Šå‡äº† <span class="text-green-600 bg-green-50 px-1 rounded font-bold">+0.24%</span> ï¼Œå…¶ä¸­iosç³»ç»Ÿçš„å¢é•¿å¹…åº¦è¾ƒå¤§ä¸º <span class="text-green-600 bg-green-50 px-1 rounded font-bold">+18.19%</span> ï¼›ä¸”ç›´æ’­æ”¯ä»˜CTCVRã€ç›´æ’­æ”¯ä»˜CVRä¹Ÿä¸Šå‡äº†ï¼Œè¿™äº›å› ç´ å¯èƒ½å…±åŒå¯¼è‡´è´§æ¶å¡ç‰‡ç‚¹å‡»æ¸—é€ç‡çš„å¢é•¿ã€‚`;

                 let execIndex = 0;
                 const execTimer = setInterval(() => {
                     if (execIndex < executionText.length) {
                         setStreamData(prev => ({ ...prev, execution: prev.execution + executionText.charAt(execIndex) }));
                         execIndex++;
                     } else {
                         clearInterval(execTimer);
                         setIsExecutionFinished(true); // Mark execution stream as finished
                         
                         // Start Result Stream
                         setTimeout(() => {
                             setStreamData(prev => ({ ...prev, result: resultText }));
                             setAnalysisState('done');
                         }, 500);
                     }
                 }, 20);
             };

             const editor = useEditor({
                extensions: [
                    StarterKit,
                    Placeholder.configure({
                        placeholder: 'è¯·å‘Šè¯‰æˆ‘ä½ æƒ³åˆ†æä»€ä¹ˆï¼Œé€šè¿‡â€œ@â€é€‰æ‹©æŒ‡æ ‡/ç»´åº¦/çœ‹æ¿',
                    }),
                    CustomMention.configure({
                        HTMLAttributes: {
                            class: 'mention text-indigo-500 font-medium bg-indigo-50 px-1 py-0.5 rounded mx-0.5 inline-block items-center align-middle',
                        },
                        suggestion: {
                            command: ({ editor, range, props }) => {
                                const type = props.type || 'metric';
                                editor
                                    .chain()
                                    .focus()
                                    .insertContentAt(range, [
                                        {
                                            type: 'mention',
                                            attrs: {
                                                id: props.id,
                                                label: props.label,
                                                type: type
                                            }
                                        },
                                        {
                                            type: 'text',
                                            text: ' '
                                        }
                                    ])
                                    .run()
                            },
                            items: ({ query }) => {
                                // 1. Gather Current Page Items
                                const currentItems = [];
                                
                                const safeSections = sectionsRef.current || [];
                                safeSections.forEach(section => {
                                    if (section && section.blocks) {
                                        section.blocks.forEach(block => {
                                            if (!block) return;
                                            const title = block.title || '';
                                            if (block.type === 'table') {
                                                 currentItems.push({ id: block.id, label: title, type: 'metric', source: 'current' });
                                            } else if (block.type === 'analysis_card') {
                                                 currentItems.push({ id: block.id, label: title, type: 'analysis_card', source: 'current' });
                                            }
                                        });
                                    }
                                });

                                // 2. Gather All Items (Static)
                                const allItems = ALL_METRICS.map(m => ({ ...m, source: 'all' }));

                                // 3. Filter and Combine
                                const normalize = str => (str || '').toLowerCase().replace(/\s+/g, '');
                                const q = normalize(query);
                                
                                const filteredCurrent = currentItems.filter(item => {
                                    const label = normalize(item.label);
                                    return label.includes(q);
                                });
                                
                                const filteredAll = allItems.filter(item => {
                                    const label = normalize(item.label);
                                    return label.includes(q);
                                });

                                return [...filteredCurrent, ...filteredAll];
                            },
                            render: () => {
                                let component;
                                let popup;

                                return {
                                    onStart: props => {
                                        component = new ReactRenderer(MentionList, {
                                            props,
                                            editor: props.editor,
                                        });

                                        if (!props.clientRect) {
                                            return;
                                        }

                                        popup = tippy('body', {
                                            getReferenceClientRect: props.clientRect,
                                            appendTo: () => document.body,
                                            content: component.element,
                                            showOnCreate: true,
                                            interactive: true,
                                            trigger: 'manual',
                                            placement: 'bottom-start',
                                        });
                                    },
                                    onUpdate(props) {
                                        component.updateProps(props);
                                        if (!props.clientRect) {
                                            return;
                                        }
                                        popup[0].setProps({
                                            getReferenceClientRect: props.clientRect,
                                        });
                                    },
                                    onKeyDown(props) {
                                        if (props.event.key === 'Escape') {
                                            popup[0].hide();
                                            return true;
                                        }
                                        return component.ref?.onKeyDown(props);
                                    },
                                    onExit() {
                                        popup[0].destroy();
                                        component.destroy();
                                    },
                                };
                            },
                        },
                    }),
                ],
                editorProps: {
                    attributes: {
                        class: 'focus:outline-none text-foreground w-full text-xs min-h-[20px] max-h-[60px] overflow-y-auto flex items-center',
                    },
                },
                onUpdate: ({ editor }) => {
                    setHasContent(!editor.isEmpty);
                },
            });

            if (!editor) {
                return null;
            }

            if (analysisState !== 'idle') {
                return (
                    <AIResultCard 
                        query={streamData.query} 
                        executionContent={streamData.execution} 
                        resultContent={streamData.result}
                        isStreamFinished={analysisState === 'done'}
                        isExecutionFinished={isExecutionFinished}
                        onClose={() => setAnalysisState('idle')}
                        onRefresh={handleAnalyze}
                    />
                );
            }

            return (
                <div className="relative p-[1px] rounded-xl bg-gradient-to-r from-blue-300 via-indigo-300 to-purple-300 shadow-sm cursor-text group hover:ring-2 hover:ring-blue-100 hover:shadow-md transition-all">
                    <div className="bg-white rounded-xl px-4 py-2 flex items-center justify-between text-xs transition-colors relative z-10" onClick={() => editor.chain().focus().run()}>
                        <div className="flex items-center flex-1 mr-2 overflow-hidden">
                           <img src="assets/images/icon/AIstar.svg" className="mr-3 w-4 h-4 flex-shrink-0" alt="AI Star" />
                           <EditorContent editor={editor} className="flex-1 w-full" />
                        </div>
                        <div 
                            className={cn(
                                "rounded-md w-6 h-6 flex items-center justify-center transition-colors cursor-pointer flex-shrink-0",
                                hasContent ? "bg-gradient-to-r from-blue-600 to-indigo-600 text-white" : "bg-gray-200 text-white"
                            )}
                            onClick={(e) => {
                                e.stopPropagation();
                                handleAnalyze();
                            }}
                        >
                           <ArrowUp size={14} />
                        </div>
                   </div>
               </div>
            );
        };

        // --- APP COMPONENTS ---
        
        const GlobalHeader = () => (
          <header className="h-12 bg-background flex items-center justify-between px-4 fixed w-full top-0 z-50 shadow-sm">
            {/* Left Section: Menu, Logo, Product Switcher */}
            <div className="flex items-center space-x-4">
              {/* Global Menu */}
              <Button variant="ghost" size="icon" className="text-muted-foreground hover:text-foreground h-8 w-8">
                <LayoutGrid size={18} />
              </Button>

              {/* Logo */}
              <div className="flex items-center space-x-2 font-bold text-lg text-primary">
                  <img src="./assets/images/libra_logo.png" alt="Libra Logo" className="h-6 w-auto mr-2" />
                  <span className="text-foreground hidden md:inline-block text-base">Libra</span>
               </div>

              <Separator orientation="vertical" className="h-4 mx-2" />

              {/* Product Mode Switcher */}
              <div className="flex items-center space-x-1 text-sm font-medium cursor-pointer hover:bg-muted/50 px-2 py-1 rounded transition-colors">
                  <span>A/Bæµ‹è¯•</span>
                  <ChevronDown size={14} className="text-muted-foreground" />
              </div>
            </div>

            {/* Center Section: Product Navigation */}
            <div className="absolute left-1/2 transform -translate-x-1/2">
                <nav className="flex items-center space-x-1">
                    <Button variant="ghost" className="text-blue-600 hover:text-blue-700 h-8 px-3 text-sm font-medium">
                        å®éªŒåˆ—è¡¨
                    </Button>
                    <Button variant="ghost" className="text-muted-foreground hover:text-foreground h-8 px-3 text-sm font-medium">
                        å®éªŒçœ‹æ¿
                    </Button>
                    <Button variant="ghost" className="text-muted-foreground hover:text-foreground h-8 px-3 text-sm font-medium space-x-1">
                        <span>å®éªŒå‘å¸ƒ</span>
                        <ChevronDown size={12} />
                    </Button>
                    <Button variant="ghost" className="text-muted-foreground hover:text-foreground h-8 px-3 text-sm font-medium space-x-1">
                        <span>å®éªŒå·¥å…·</span>
                        <ChevronDown size={12} />
                    </Button>
                    <Button variant="ghost" className="text-muted-foreground hover:text-foreground h-8 px-3 text-sm font-medium space-x-1">
                        <span>å®éªŒæŒ‡æ ‡</span>
                        <ChevronDown size={12} />
                    </Button>
                    <Button variant="ghost" className="text-muted-foreground hover:text-foreground h-8 px-3 text-sm font-medium">
                        äº§å“ç®¡ç†
                    </Button>
                </nav>
            </div>

            {/* Right Section: IDC, Tools, User */}
            <div className="flex items-center space-x-3">
              {/* IDC Selector */}
              <Button variant="outline" size="sm" className="h-8 text-xs font-normal text-muted-foreground border-border hover:border-solid hover:text-foreground space-x-2 hidden lg:flex">
                  <img src="assets/images/icon/folder.svg" width="14" height="14" alt="folder" />
                  <span>ä¸­å›½æœºæˆ¿</span>
                  <ChevronDown size={12} />
              </Button>

              <div className="flex items-center space-x-1">
                  <Button variant="ghost" size="icon" className="h-8 w-8 text-green-600 hover:text-green-700 hover:bg-green-50">
                    <CheckCircle2 size={16} />
                  </Button>
                  <Button variant="ghost" size="icon" className="h-8 w-8 text-muted-foreground hover:text-foreground">
                    <HelpCircle size={16} />
                  </Button>
                  <Button variant="ghost" size="icon" className="h-8 w-8 text-muted-foreground hover:text-foreground">
                    <Bell size={16} />
                  </Button>
                   <Button variant="ghost" size="icon" className="h-8 w-8 text-muted-foreground hover:text-foreground">
                    <Languages size={16} />
                  </Button>
              </div>

              <Separator orientation="vertical" className="h-5 mx-1" />

              {/* User Avatar */}
              <div className="w-7 h-7 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 p-[1.5px] cursor-pointer">
                  <div className="w-full h-full rounded-full bg-background border-2 border-transparent overflow-hidden">
                       <img src="https://github.com/shadcn.png" alt="User" className="w-full h-full object-cover" />
                  </div>
              </div>
            </div>
          </header>
        );

        const ExperimentToolbar = () => (
          <div className="sticky top-12 z-40 bg-[#FAFBFC] border-b h-24 flex flex-col justify-between px-6">
            <div className="flex justify-between items-center pt-4">
              <div className="flex items-center space-x-3">
                <h1 className="text-[18px] font-bold text-foreground tracking-tight">æœ¬åœ°ç›´æ’­-è´§æ¶å¼¹å‡ºåç›´æ’­ç”»é¢è‡ªé€‚åº”-é‡å¼€</h1>
                
                {/* Status Badge */}
                <Badge className="bg-blue-50 text-blue-600 h-5.5 border border-gray-200 rounded-sm px-2 py-0.5 font-medium">
                    è¿è¡Œä¸­
                </Badge>

                {/* Metadata */}
                <div className="flex items-center space-x-2 ml-2">
                   <div className="flex items-center space-x-1 px-2 py-0.5 border rounded-sm bg-background text-muted-foreground text-xs font-medium">
                        <User size={12} />
                        <span>22.7k</span>
                   </div>
                   <div className="flex items-center space-x-1 px-2 py-0.5 border rounded-sm bg-background text-muted-foreground text-xs font-medium">
                        <Activity size={12} />
                        <span>22.7k</span>
                   </div>
                   <div className="text-yellow-400 cursor-pointer hover:text-yellow-500">
                        <Star size={16} fill="currentColor" /> 
                   </div>
                </div>
              </div>

              {/* Right Actions */}
              <div className="flex items-center space-x-3">
                <Button variant="ghost" size="icon" className="h-8 w-8 text-muted-foreground hover:text-foreground"><Pencil size={16}/></Button>
                <Button variant="ghost" size="icon" className="h-8 w-8 text-muted-foreground hover:text-foreground"><Copy size={16}/></Button>
                <Button variant="ghost" size="icon" className="h-8 w-8 text-muted-foreground hover:text-foreground"><History size={16}/></Button>
                <Button variant="ghost" size="icon" className="h-8 w-8 text-muted-foreground hover:text-foreground"><Target size={16}/></Button>
                
                <Separator orientation="vertical" className="h-4 mx-3" />
                
                <Button variant="outline" size="sm" className="h-8 text-[13px]">æŸ¥çœ‹éªŒè¯å®éªŒ</Button>
                <Button variant="outline" size="sm" className="h-8 text-[13px]"><img src="assets/images/icon/Pause.svg" width="14" height="14" className="mr-1" alt="Pause" /> æš‚åœ</Button>
                <Button variant="outline" size="sm" className="h-8 text-[13px] text-red-600 hover:text-red-700 hover:bg-red-50 border-red-200"><img src="assets/images/icon/Stop.svg" width="14" height="14" className="mr-1" alt="Stop" /> åœæ­¢</Button>
              </div>
            </div>
            
            {/* Tabs */}
            <div className="flex space-x-8 text-sm font-medium">
              {['å®éªŒè¯¦æƒ…', 'å®éªŒæŠ¥å‘Š', 'ç»“è®ºæŠ¥å‘Š', 'é«˜çº§åˆ†æ', 'å®éªŒæŠ¥è­¦', 'å®éªŒä¸Šçº¿'].map((tab, idx) => (
                <div key={tab} className={`pb-3 cursor-pointer relative ${idx === 1 ? 'text-primary' : 'text-muted-foreground hover:text-foreground transition-colors'}`}>
                  <div className="flex items-center">
                    {tab}
                    {tab === 'ç»“è®ºæŠ¥å‘Š' && <Badge variant="secondary" className="ml-1.5 px-1 py-0 h-4 bg-blue-100 text-blue-700 hover:bg-blue-100 text-[10px] rounded-sm">AI</Badge>}
                  </div>
                  {idx === 1 && <div className="absolute bottom-0 left-0 w-full h-0.5 bg-primary"></div>}
                </div>
              ))}
            </div>
          </div>
        );

        const Sidebar = ({ sections, onUpdateSectionTitle, onAddSection, onAddBlock, contentRef }) => {
          const [expanded, setExpanded] = useState({});
          const [editingId, setEditingId] = useState(null);
          const [tempTitle, setTempTitle] = useState("");
          const [collapsed, setCollapsed] = useState(window.innerWidth < 1500);
          const [activeId, setActiveId] = useState(null);

          useEffect(() => {
              const newExpanded = {};
              sections.forEach(s => { 
                  newExpanded[s.id] = true;
                  // Auto expand sub-groups
                  const subGroups = s.blocks.filter(b => b.type === 'divider');
                  subGroups.forEach(g => newExpanded[g.id] = true);
              });
              setExpanded(newExpanded);
          }, [sections]);

          useEffect(() => {
              const handleScroll = () => {
                  let currentActiveId = null;

                  // Flatten all checkable items
                  const allItems = [];
                  sections.forEach(section => {
                      allItems.push(section.id);
                      section.blocks.forEach(block => {
                          allItems.push(block.id);
                      });
                  });

                  for (const id of allItems) {
                      const element = document.getElementById(id);
                      if (element) {
                          const rect = element.getBoundingClientRect();
                          // Consider container offset if available
                          const containerRect = contentRef.current ? contentRef.current.getBoundingClientRect() : { top: 0, bottom: window.innerHeight };
                          
                          // Check if element top is within a reasonable range from the top of the container
                          if (rect.top >= containerRect.top && rect.top <= containerRect.top + 300) {
                              currentActiveId = id;
                              break; // Found the top-most visible element
                          }
                      }
                  }
                  
                  if (currentActiveId) {
                      setActiveId(currentActiveId);
                  }
              };

              let timeoutId = null;
              const debouncedHandleScroll = () => {
                  if (timeoutId) clearTimeout(timeoutId);
                  timeoutId = setTimeout(handleScroll, 100);
              };

              const container = contentRef.current;
              if (container) {
                  container.addEventListener('scroll', debouncedHandleScroll);
              }

              return () => {
                  if (container) {
                      container.removeEventListener('scroll', debouncedHandleScroll);
                  }
                  if (timeoutId) clearTimeout(timeoutId);
              };
          }, [sections, contentRef]);

          const toggle = (id) => {
            setExpanded(prev => ({ ...prev, [id]: !prev[id] }));
          };

          const handleStartEdit = (section, e) => {
              e.stopPropagation();
              setEditingId(section.id);
              setTempTitle(section.title);
          };

          const handleSaveEdit = (sectionId) => {
              if (tempTitle.trim()) {
                onUpdateSectionTitle(sectionId, tempTitle);
              }
              setEditingId(null);
          };

          const scrollToBlock = (id) => {
              // Note: setActiveId was not defined in App scope before. 
              // We need to decide how to handle the "active" state in Sidebar.
              // For now, we can just dispatch an event or expose a method if needed, 
              // but purely for scrolling, we don't strictly need to set active ID in App state 
              // unless we lift Sidebar's activeId state up to App.
              
              // If we want Sidebar to highlight the item, we might need to lift state.
              // But given the previous error, let's just fix the scroll first.
              
              const element = document.getElementById(id);
              if (element && contentRef.current) {
                  // Use scrollIntoView which works within overflow containers
                  element.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
          };

          const generateItems = () => {
              return sections.map(section => {
                  const rootChildren = [];
                  let lastLevel1 = null;
                  let lastLevel2 = null;
                  let lastLevel3 = null;

                  section.blocks.forEach(block => {
                      if (block.type === 'divider') {
                          const level = block.level || 'ä¸€çº§';
                          const group = {
                              id: block.id,
                              label: block.title,
                              type: 'group',
                              level: level,
                              children: []
                          };

                          if (level === 'ä¸€çº§') {
                              rootChildren.push(group);
                              lastLevel1 = group;
                              lastLevel2 = null;
                              lastLevel3 = null;
                          } else if (level === 'äºŒçº§') {
                              if (lastLevel1) {
                                  lastLevel1.children.push(group);
                              } else {
                                  rootChildren.push(group);
                              }
                              lastLevel2 = group;
                              lastLevel3 = null;
                          } else if (level === 'ä¸‰çº§') {
                              if (lastLevel2) {
                                  lastLevel2.children.push(group);
                              } else if (lastLevel1) {
                                  lastLevel1.children.push(group);
                              } else {
                                  rootChildren.push(group);
                              }
                              lastLevel3 = group;
                          } else {
                              // Fallback for unknown levels
                              rootChildren.push(group);
                              lastLevel1 = group;
                              lastLevel2 = null;
                              lastLevel3 = null;
                          }
                      } else {
                          const item = {
                              id: block.id,
                              label: block.title || (block.type === 'text' ? 'æ–‡æœ¬å—' : 'æœªå‘½åæ¨¡å—'),
                              type: 'item',
                              blockType: block.type
                          };
                          
                          if (lastLevel3) {
                              lastLevel3.children.push(item);
                          } else if (lastLevel2) {
                              lastLevel2.children.push(item);
                          } else if (lastLevel1) {
                              lastLevel1.children.push(item);
                          } else {
                              rootChildren.push(item);
                          }
                      }
                  });

                  return {
                      id: section.id,
                      label: section.title,
                      type: 'folder',
                      children: rootChildren
                  };
              });
          };

          const items = generateItems();

          const getBlockIcon = (type, isActive) => {
              // Tailwind blue-600 (#2563eb) filter approximation
              const activeFilter = "invert(32%) sepia(82%) saturate(2379%) hue-rotate(213deg) brightness(97%) contrast(96%)";
              
              const iconClass = cn(
                  "mr-2 transition-all",
                  !isActive && "grayscale opacity-60 group-hover:grayscale-0 group-hover:opacity-100"
              );
              
              const activeStyle = isActive ? { filter: activeFilter } : undefined;

              switch (type) {
                  case 'text': return <img src="assets/images/icon/Text.svg" width="14" height="14" alt="Text" className={iconClass} style={activeStyle} />;
                  case 'table': return <img src="assets/images/icon/Chart.svg" width="14" height="14" alt="Chart" className={iconClass} style={activeStyle} />;
                  case 'metric_selector': return <img src="assets/images/icon/Chart.svg" width="14" height="14" alt="Chart" className={iconClass} style={activeStyle} />;
                  case 'analysis_card': return <img src="assets/images/icon/DrillDown.svg" width="14" height="14" alt="DrillDown" className={iconClass} style={activeStyle} />;
                  case 'analysis_selector': return <img src="assets/images/icon/DrillDown.svg" width="14" height="14" alt="DrillDown" className={iconClass} style={activeStyle} />;
                  case 'ask_ai': return <Sparkles size={14} className={cn("mr-2", isActive ? "text-blue-600" : "text-muted-foreground group-hover:text-foreground")} />;
                  default: return <img src="assets/images/icon/Text.svg" width="14" height="14" alt="Text" className={iconClass} style={activeStyle} />;
              }
          };

          const renderItem = (item, depth = 0) => {
            const isExpanded = expanded[item.id];
            const isEditing = editingId === item.id;
            const hasChildren = item.children && item.children.length > 0;
            const isFolder = item.type === 'folder';
            const isGroup = item.type === 'group';
            const isActive = activeId === item.id;

            // Sticky logic: Section headers (folders) stick to top
            const stickyStyle = isFolder ? { position: 'sticky', top: 0, zIndex: 10, backgroundColor: 'hsl(var(--background))' } : {};

            return (
              <div key={item.id} className="select-none">
                <div 
                  className={cn(
                      "flex items-center px-2 py-1 text-[12px] cursor-pointer rounded-md transition-colors group",
                      isActive ? 'bg-blue-50 text-blue-600 font-medium' : 'text-muted-foreground hover:bg-secondary/50 hover:text-foreground',
                      isFolder ? "font-semibold text-foreground py-2" : "",
                      isGroup ? "font-medium text-foreground/80 mt-1" : ""
                  )}
                  style={{ 
                      paddingLeft: collapsed ? '8px' : `${depth * 12 + 8}px`,
                      ...stickyStyle
                  }}
                  onClick={() => hasChildren ? toggle(item.id) : scrollToBlock(item.id)}
                  title={collapsed ? item.label : undefined}
                >
                  {/* Folder/Group Icons or Indentation */}
                  {hasChildren && !collapsed && !isFolder && (
                    <span className="mr-1 text-muted-foreground w-4 inline-flex justify-center">
                        {isExpanded ? <ChevronDown size={12}/> : <ChevronRight size={12}/>}
                    </span>
                  )}
                  {!hasChildren && !collapsed && null}
                  
                  {/* Item Type Icons */}
                  {isFolder && collapsed && <Folder size={14} className="mx-auto" />}
                  {isFolder && !collapsed && <img src="/assets/images/icon/file.svg" className="mr-2 w-[18px] h-[18px]" />}
                  
                  {!isFolder && item.type === 'item' && !collapsed && getBlockIcon(item.blockType, isActive)}

                  {/* Label or Edit Input */}
                  {!collapsed && (
                      isEditing ? (
                          <input 
                            value={tempTitle}
                            onChange={(e) => setTempTitle(e.target.value)}
                            onBlur={() => handleSaveEdit(item.id)}
                            onKeyDown={(e) => e.key === 'Enter' && handleSaveEdit(item.id)}
                            onClick={(e) => e.stopPropagation()}
                            className="flex-1 bg-background border rounded px-1 py-0.5 text-xs focus:outline-none focus:ring-1 focus:ring-primary"
                            autoFocus
                          />
                      ) : (
                          <>
                            <span className="truncate flex-1">{item.label}</span>
                            {isFolder && (
                                <div className="flex items-center ml-auto px-1 space-x-1">
                                    {/* Hover Actions: Rename */}
                                    <div className="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        <Button
                                            variant="ghost"
                                            size="icon"
                                            className="h-5 w-5 mr-1 text-muted-foreground hover:text-foreground"
                                            onClick={(e) => handleStartEdit({ id: item.id, title: item.label }, e)}
                                        >
                                            <Pencil size={12} />
                                        </Button>
                                    </div>

                                    {/* Add Metric Group - Always Visible, Outline, Far Right */}
                                    <Button
                                        variant="outline"
                                        size="icon"
                                        className="h-5 w-5 text-muted-foreground hover:text-primary bg-background hover:border-solid hover:border-primary/50"
                                        title="æ·»åŠ æŒ‡æ ‡ç»„"
                                        onClick={(e) => { e.stopPropagation(); onAddBlock(item.id, 'metric'); }}
                                    >
                                        <Plus size={12} />
                                    </Button>
                                </div>
                            )}
                          </>
                      )
                  )}
                </div>
                {hasChildren && isExpanded && !collapsed && (
                  <div className="mt-0.5">
                    {item.children.map(child => renderItem(child, depth + 1))}
                  </div>
                )}
              </div>
            );
          };

          return (
            <div className={cn(
                "flex-shrink-0 h-full flex flex-col transition-all duration-300",
                collapsed ? "w-0" : "w-[240px] bg-background border-r border-border/50"
            )}>
                {collapsed ? (
                    <div className="absolute left-3 top-3 z-50">
                        <Button 
                            variant="secondary" 
                            size="icon" 
                            className="h-7 w-7 rounded-[8px] shadow-md bg-background border border-border/50 text-muted-foreground hover:text-foreground"
                            onClick={() => setCollapsed(false)}
                            title="å±•å¼€å¯¼èˆª"
                        >
                            <img src="assets/images/icon/menu.svg" className="w-4 h-4" />
                        </Button>
                    </div>
                ) : (
                    <>
                        <div className="p-4 pb-2 flex-shrink-0">
                            <div className="flex items-center justify-between">
                                <div className="flex space-x-1">
                                    <Button 
                                        variant="ghost" 
                                        size="icon" 
                                        className="h-6 w-6 text-muted-foreground hover:text-foreground"
                                        onClick={() => setCollapsed(true)}
                                    >
                                        <img src="assets/images/icon/menu.svg" className="w-4 h-4" />
                                    </Button>
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 pt-0 space-y-1">
                            {items.map(item => renderItem(item))}
                        </div>
                    </>
                )}
            </div>
          );
        };

        const SummaryCard = () => (
          <Card className="mb-6 border-blue-100 bg-blue-50/10 p-4">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-xs font-bold flex items-center text-foreground">
                    <Sparkles size={14} className="text-primary mr-2" />
                    å®éªŒæ€»ç»“
                </CardTitle>
                <div className="flex space-x-2">
                    <PromptEditorButton variant="outline" size="xs" className="h-7 text-xs bg-background" />
                    <Button variant="outline" size="icon" className="h-7 w-7"><RefreshCw size={14}/></Button>
                </div>
            </CardHeader>
            <CardContent>
                <div className="text-[13px] text-muted-foreground space-y-0 leading-relaxed">
                  <div className="flex items-start">
                    <div className="text-[13px]">
                      <span className="font-bold text-foreground">æ ¸å¿ƒæŒ‡æ ‡æ˜¾è‘—æå‡å®éªŒç»„åœ¨æ ¸å¿ƒäº¤æ˜“æŒ‡æ ‡å–å¾—æ­£å‘æ”¶ç›Šï¼š</span>
                      ç›´æ’­GMV æ˜¾è‘—æå‡ <Badge variant="success" className="bg-green-100 text-green-700 ml-1 text-[14px]">+6.27%</Badge>ï¼Œ
                      ç›´æ’­äººå‡è®¢å•æ•° æ˜¾è‘—æå‡ <Badge variant="success" className="bg-green-100 text-green-700 ml-1 text-[14px]">+7.27%</Badge>ï¼Œ
                      éªŒè¯äº†ç”»é¢è‡ªé€‚åº”å¯¹äº¤æ˜“æ•ˆç‡çš„ä¿ƒè¿›ä½œç”¨ã€‚
                    </div>
                  </div>
                  <div className="flex items-start">
                    <div className="text-[13px]">
                      <span className="font-bold text-foreground">ç”¨æˆ·è¡Œä¸ºåˆ†åŒ–æ˜æ˜¾ï¼š</span>
                      å•†å®¶è‡ªæ’­åœºæ™¯è¡¨ç°æœ€ä½³ï¼š æ”¯ä»˜UVæ¸—é€ç‡ <Badge variant="success" className="bg-green-100 text-green-700 ml-1 text-[14px]">+0.16%</Badge>ï¼Œ
                      äººå‡è®¢å•æ•° <Badge variant="success" className="bg-green-100 text-green-700 ml-1 text-[14px]">+0.29%</Badge> æ˜¾è‘—æå‡ï¼Œè‡ªé€‚åº”ç­–ç•¥æ›´å¥‘åˆå•†å“è®²è§£å‹ç›´æ’­ã€‚
                    </div>
                  </div>
                  <div className="flex items-start">
                    <div className="text-[13px]">
                      <span className="font-bold text-foreground">æ”¯ä»˜æ´»è·ƒç”¨æˆ·æ”¶ç›Šæ˜¾è‘—ï¼š</span>
                      äººå‡è®¢å•æ•° <Badge variant="success" className="bg-green-100 text-green-700 ml-1 text-[14px]">+7.27%</Badge> å’Œ 
                      ç›´æ’­GMV <Badge variant="success" className="bg-green-100 text-green-700 ml-1 text-[14px]">+6.27%</Badge> æå‡ï¼Œè€Œ
                      æ”¯ä»˜æµå¤±ç”¨æˆ·è´§æ¶æ”¯ä»˜CVR <Badge variant="destructive" className="bg-red-50 text-red-600 ml-1 text-[14px]">-1.10%</Badge> ä¸‹é™ï¼Œ
                      éœ€å…³æ³¨æµå¤±ç”¨æˆ·å¯¹æ–°äº¤äº’çš„é€‚åº”æ€§ã€‚
                    </div>
                  </div>
                </div>
            </CardContent>
          </Card>
        );

        const AnalysisTable = ({ title, metricType }) => (
            <div className="border rounded-xl bg-white overflow-hidden hover:shadow-sm transition-all">
                <div className="px-6 py-4 border-b bg-muted/30 flex justify-between items-center">
                    <div className="flex items-center space-x-3">
                        <div className="cursor-pointer text-muted-foreground hover:text-foreground transition-colors mr-1">
                            <ChevronDown size={16}/>
                        </div>
                        <h3 className="text-[14px] font-bold text-foreground whitespace-nowrap overflow-hidden text-ellipsis max-w-[400px]">{title}</h3>
                        <div className="flex items-center space-x-2 ml-2">
                             <Badge variant="secondary" className="bg-teal-50 text-teal-600 border-teal-200/50 hover:bg-teal-100 cursor-pointer text-[10px] h-5 px-1.5 font-normal">ä»å¤´ç´¯è®¡</Badge>
                             <Badge variant="secondary" className="bg-blue-50 text-blue-600 border-blue-200/50 hover:bg-blue-100 cursor-pointer text-[10px] h-5 px-1.5 font-normal">æ•°æ®äº§å‡ºåŠ©æ‰‹</Badge>
                        </div>
                    </div>
                    <div className="flex items-center space-x-4 text-xs text-muted-foreground">
                        <div className="hidden min-[1500px]:flex items-center space-x-4">
                            <span className="flex items-center cursor-pointer hover:text-foreground">æ•°æ®å£å¾„ <Badge variant="secondary" className="ml-1 bg-blue-50 text-blue-600 hover:bg-blue-100 cursor-pointer text-[10px] h-5 px-1.5 font-medium">CUPED</Badge></span>
                            <div className="w-[1px] h-3 bg-border"></div>
                            <span className="flex items-center cursor-pointer hover:text-foreground">æ˜¾è‘—æ€§æ°´å¹³ <Badge variant="secondary" className="ml-1 bg-blue-50 text-blue-600 hover:bg-blue-100 cursor-pointer text-[10px] h-5 px-1.5 font-medium">5%</Badge></span>
                            <div className="w-[1px] h-3 bg-border"></div>
                            <span className="flex items-center cursor-pointer hover:text-foreground">å¤šé‡æ¯”è¾ƒä¿®æ­£ <Badge variant="secondary" className="ml-1 bg-blue-50 text-blue-600 hover:bg-blue-100 cursor-pointer text-[10px] h-5 px-1.5 font-medium">å¼€</Badge></span>
                        </div>
                        <div className="flex min-[1500px]:hidden relative items-center space-x-4">
                             <span className="flex items-center cursor-pointer hover:text-foreground">æ•°æ®å£å¾„ <Badge variant="secondary" className="ml-1 bg-blue-50 text-blue-600 hover:bg-blue-100 cursor-pointer text-[10px] h-5 px-1.5 font-medium">CUPED</Badge></span>
                             <div className="w-[1px] h-3 bg-border"></div>
                             <Button variant="ghost" size="icon" className="h-6 w-6"><MoreHorizontal size={14}/></Button>
                        </div>
                    </div>
                </div>

                {/* Table Content (Mock) */}
                <div className="overflow-x-auto">
                    <table className="w-full text-xs text-left">
                        <thead className="text-xs text-muted-foreground bg-muted/20 border-b">
                            <tr>
                                <th className="px-6 py-3 font-medium">æŒ‡æ ‡åç§°</th>
                                <th className="px-6 py-3 font-medium">å®éªŒç»„å‡å€¼</th>
                                <th className="px-6 py-3 font-medium">å¯¹ç…§ç»„å‡å€¼</th>
                                <th className="px-6 py-3 font-medium">å˜åŒ–ç‡</th>
                                <th className="px-6 py-3 font-medium">ç½®ä¿¡åŒºé—´</th>
                                <th className="px-6 py-3 font-medium text-right">P-value</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y">
                            {[1, 2, 3].map((row) => (
                                <tr key={row} className="hover:bg-muted/10 transition-colors group">
                                    <td className="px-6 py-3 font-medium text-foreground">
                                        <div className="flex items-center">
                                            <span>æŒ‡æ ‡ {row}</span>
                                            <Info size={12} className="ml-1 text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer"/>
                                        </div>
                                    </td>
                                    <td className="px-6 py-3 text-muted-foreground">1,234.56</td>
                                    <td className="px-6 py-3 text-muted-foreground">1,100.00</td>
                                    <td className="px-6 py-3 font-medium text-green-600 bg-green-50/50">+12.2%</td>
                                    <td className="px-6 py-3 text-muted-foreground">[10.1%, 14.3%]</td>
                                    <td className="px-6 py-3 text-right text-muted-foreground">0.001</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
                
                {/* Pagination / Footer */}
                <div className="px-6 py-3 border-t flex justify-between items-center bg-gray-50/50">
                    <span className="text-[10px] text-muted-foreground">æ˜¾ç¤º 1-3 å…± 3 æ¡</span>
                    <div className="flex space-x-1">
                         <Button variant="ghost" size="sm" className="h-6 w-6 p-0" disabled><ChevronLeft size={12}/></Button>
                         <Button variant="ghost" size="sm" className="h-6 w-6 p-0 bg-white border shadow-sm text-xs">1</Button>
                         <Button variant="ghost" size="sm" className="h-6 w-6 p-0" disabled><ChevronRight size={12}/></Button>
                    </div>
                </div>
            </div>
        );

        const ThinkingMetricItem = ({ item, onClick, analyzedMetrics, onAnalysisClick }) => {
            // Find analyzed metrics that match this item's label or are related to this item's group
            // For now, we'll check if any analyzed metric starts with or contains the item label to simulate grouping
            const relatedAnalyzedMetrics = analyzedMetrics?.filter(m => m === item.label || m.startsWith(item.label + '/') || m.includes(item.label));
            const hasAnalysis = relatedAnalyzedMetrics && relatedAnalyzedMetrics.length > 0;
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const menuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsMenuOpen(false);
                    }
                };
                if (isMenuOpen) {
                    document.addEventListener('mousedown', handleClickOutside);
                }
                return () => {
                    document.removeEventListener('mousedown', handleClickOutside);
                };
            }, [isMenuOpen]);

            return (
                <div className="relative">
                    <div 
                        className="group flex items-center space-x-2 bg-gray-100 hover:bg-gray-100 border border-transparent px-2.5 py-1 rounded-md text-xs text-gray-600 hover:text-foreground cursor-pointer transition-all w-max max-w-full"
                        onClick={() => onClick && onClick(item.label)}
                    >
                         {item.type === 'dimension' ? 
                            <img src="assets/images/icon/dimension.svg" className="w-3 h-3 text-gray-400 group-hover:text-indigo-500 transition-colors shrink-0" /> : 
                            <img src="assets/images/icon/Chart.svg" width="12" height="12" alt="Chart" className="text-gray-400 group-hover:text-indigo-500 transition-colors shrink-0"/>
                        }
                        <span className="truncate font-medium">{item.label}</span>
                        {hasAnalysis && (
                            <div className="relative" ref={menuRef}>
                                <div 
                                    className="ml-1 pl-1 pr-1.5 py-0.5 rounded-sm hover:bg-gray-200 cursor-pointer flex items-center space-x-0.5"
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        if (relatedAnalyzedMetrics.length === 1) {
                                            onAnalysisClick && onAnalysisClick(relatedAnalyzedMetrics[0]);
                                        } else {
                                            setIsMenuOpen(!isMenuOpen);
                                        }
                                    }}
                                    title="æŸ¥çœ‹ AI å½’å› åˆ†æ"
                                >
                                    <img src="assets/images/icon/AIstar.svg" className="w-3 h-3" />
                                    <span className="text-[10px] text-gray-500 font-medium">{relatedAnalyzedMetrics.length}</span>
                                </div>
                                {isMenuOpen && (
                                    <div className="fixed mt-1 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-[9999] py-1" style={{ left: menuRef.current?.getBoundingClientRect().left - 96 + menuRef.current?.getBoundingClientRect().width / 2, top: menuRef.current?.getBoundingClientRect().bottom }}>
                                        {relatedAnalyzedMetrics.map((metric, idx) => {
                                            const displayName = metric.startsWith(item.label + '/') ? metric.split('/').pop() : metric;
                                            return (
                                                <div 
                                                    key={idx}
                                                    className="px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-100 cursor-pointer truncate"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        onAnalysisClick && onAnalysisClick(metric);
                                                        setIsMenuOpen(false);
                                                    }}
                                                    title={metric}
                                                >
                                                    {displayName}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {item.children && item.children.length > 0 && (
                        <div className="pl-1 mt-1.5 space-y-1.5 relative">
                             {item.children.map((child, idx) => {
                                 const isLast = idx === item.children.length - 1;
                                 return (
                                     <div key={idx} className="relative pl-4">
                                         {!isLast && (
                                             <div className="absolute left-0 top-0 bottom-0 w-px bg-gray-200"></div>
                                         )}
                                         <div className={cn(
                                             "absolute left-0 top-0 w-3 h-[14px] border-l border-b border-gray-200 rounded-bl-lg",
                                             isLast ? "bg-transparent" : ""
                                         )}></div>
                                         <ThinkingMetricItem item={child} onClick={onClick} analyzedMetrics={analyzedMetrics} onAnalysisClick={onAnalysisClick} />
                                     </div>
                                 );
                             })}
                        </div>
                    )}
                </div>
            )
        };

        const ThinkingCard = ({ group, onClick, analyzedMetrics, onAnalysisClick }) => {
            return (
                <div className="relative p-2 rounded-lg mb-3 hover:bg-gray-50 transition-colors">
                    {group.description && (
                        <div className="text-[12px] text-gray-400 mb-2 px-1 leading-normal">
                            {group.description}
                        </div>
                    )}
                    <div className="space-y-2">
                        {group.items.map((item, idx) => (
                            <ThinkingMetricItem key={idx} item={item} onClick={onClick} analyzedMetrics={analyzedMetrics} onAnalysisClick={onAnalysisClick} />
                        ))}
                    </div>
                </div>
            )
        };

        const ThinkingSidebar = ({ isVisible, onClose, onScrollTo, activeAnalysis, onCloseAnalysis, analyzedMetrics, onAnalysisClick, hasBlockChanges, onRefresh, isRefreshing }) => {
          const [isExpanded, setIsExpanded] = React.useState(false);
          
          // Streaming effect for analysis
          const [analysisContent, setAnalysisContent] = useState('');
          const fullAnalysisText = `
**æŒ‡æ ‡å½’å› åˆ†æï¼š**

1.  **æ­£å‘æ”¶ç›Šæ˜¾è‘—ï¼š** å®éªŒç»„åœ¨ **ç›´æ’­GMV** ä¸Šæå‡äº† **6.27%**ï¼Œä¸»è¦å½’å› äº **äººå‡è®¢å•æ•° (+7.27%)** çš„æ˜¾è‘—å¢é•¿ã€‚è¿™è¡¨æ˜æ–°çš„ç”»é¢è‡ªé€‚åº”ç­–ç•¥æœ‰æ•ˆæå‡äº†ç”¨æˆ·çš„ä¸‹å•æ„æ„¿ã€‚
2.  **è½¬åŒ–æ•ˆç‡æå‡ï¼š** **æ”¯ä»˜UVæ¸—é€ç‡** æå‡ **0.16%**ï¼Œè¯´æ˜æ›´å¤šè¿›å…¥ç›´æ’­é—´çš„ç”¨æˆ·å®Œæˆäº†æ”¯ä»˜è½¬åŒ–ã€‚
3.  **ç”¨æˆ·è¡Œä¸ºåˆ†åŒ–ï¼š** è™½ç„¶æ•´ä½“GMVæå‡ï¼Œä½† **åœç•™æ—¶é•¿** ç•¥æœ‰ä¸‹é™ (-0.69%)ï¼Œè¿™å¯èƒ½æ„å‘³ç€ç”¨æˆ·å†³ç­–é“¾è·¯å˜çŸ­ï¼Œæ•ˆç‡æ›´é«˜ï¼Œä½†ä¹Ÿéœ€è¦å…³æ³¨æ˜¯å¦å½±å“äº†å†…å®¹çš„é•¿æœŸå¸å¼•åŠ›ã€‚
4.  **å»ºè®®ï¼š** å»ºè®®å…¨é‡æ¨å¹¿è¯¥ç­–ç•¥ï¼Œå¹¶æŒç»­ç›‘æ§ **é€€è´§ç‡** å’Œ **ç”¨æˆ·ç•™å­˜** æŒ‡æ ‡ï¼Œç¡®ä¿é•¿æœŸç”Ÿæ€å¥åº·ã€‚
          `;

          useEffect(() => {
              if (activeAnalysis) {
                  if (activeAnalysis.isStreaming) {
                      setAnalysisContent('');
                      let index = 0;
                      const interval = setInterval(() => {
                          setAnalysisContent(prev => fullAnalysisText.slice(0, index));
                          index++;
                          if (index > fullAnalysisText.length) {
                              clearInterval(interval);
                          }
                      }, 20);
                      return () => clearInterval(interval);
                  } else {
                      setAnalysisContent(fullAnalysisText);
                  }
              }
          }, [activeAnalysis]);

          return (
            <div 
                className={cn(
                    "bg-background rounded-lg flex-shrink-0 h-[calc(100vh-168px)] sticky top-[144px] transition-all duration-300 ease-in-out overflow-hidden",
                    isVisible ? "w-80 ml-3 opacity-100 border-border" : "w-0 ml-0 opacity-0"
                )}
            >
              <div className="w-80 h-full flex flex-col bg-white/50 relative">
                  <div className="absolute inset-0 pointer-events-none z-0" style={{
                      backgroundImage: 'url(./assets/images/bg.png)',
                      backgroundRepeat: 'no-repeat',
                      backgroundSize: '100%',
                      backgroundPosition: 'top'
                  }}></div>
                  
                  <div className="flex-none p-5 py-4 flex justify-between items-center relative z-20">
                      <div className="flex items-center">
                          {activeAnalysis && (
                              <Button variant="ghost" size="sm" className="h-6 px-1 mr-1 -ml-2 text-xs text-muted-foreground hover:text-foreground font-normal" onClick={onCloseAnalysis}>
                                  <ChevronLeft size={14} className="mr-0.5" />
                                  è¿”å›çœ‹æ•°æ€è·¯
                              </Button>
                          )}
                          {!activeAnalysis && (
                              <div className="flex items-center space-x-2">
                                  <img src="assets/images/Lila.png" className="w-5 h-5 rounded-full" alt="Lila" />
                                  <h3 className="font-bold text-foreground text-sm">Lilaå¸¦ä½ é«˜æ•ˆçœ‹æ•°</h3>
                              </div>
                          )}
                      </div>
                      <div className="flex items-center space-x-1">
                              <Button variant="ghost" size="icon" className="h-6 w-6 text-muted-foreground hover:bg-muted" onClick={onRefresh} title="åˆ·æ–°" disabled={isRefreshing}>
                                  <div className="relative">
                                      <RefreshCw size={14} className={cn(isRefreshing && "animate-spin")} />
                                      {hasBlockChanges && !isRefreshing && <span className="absolute -top-0.5 -right-0.5 w-1.5 h-1.5 bg-red-500 rounded-full border border-white"></span>}
                                  </div>
                              </Button>
                              <Button variant="ghost" size="icon" className="h-6 w-6 text-muted-foreground hover:bg-muted" onClick={onClose}><span className="text-lg">Ã—</span></Button>
                          </div>
                      </div>
    
                      <div className="flex-1 overflow-y-auto px-5 pb-5 relative z-10">
                        {isRefreshing ? (
                            <div className="space-y-4 animate-pulse">
                                <div className="h-4 bg-gray-200 rounded w-3/4"></div>
                                <div className="space-y-2">
                                    <div className="h-3 bg-gray-200 rounded"></div>
                                    <div className="h-3 bg-gray-200 rounded w-5/6"></div>
                                </div>
                                <div className="h-24 bg-gray-100 rounded-lg"></div>
                                <div className="space-y-2">
                                    <div className="h-3 bg-gray-200 rounded"></div>
                                    <div className="h-3 bg-gray-200 rounded w-5/6"></div>
                                </div>
                            </div>
                        ) : (
                            <>
                    {activeAnalysis ? (
                        <div>
                            <div>
                                <div className="flex items-center mb-3 pb-2">
                                    <span className="text-[16px] font-dingtalk mr-1 bg-gradient-to-r from-blue-500 to-purple-500 bg-clip-text text-transparent leading-none">â€œ</span>
                                    <span className="text-[16px] font-medium text-foreground font-dingtalk">{activeAnalysis.title}å½’å› åˆ†æ</span>
                                    <span className="text-[16px] font-dingtalk ml-1 bg-gradient-to-r from-purple-500 to-blue-500 bg-clip-text text-transparent leading-none">â€</span>
                                </div>
                                <div className="text-[13px] text-foreground leading-relaxed markdown-body">
                                    <div dangerouslySetInnerHTML={{ __html: marked.parse(analysisContent) }} />
                                    {analysisContent.length < fullAnalysisText.length && (
                                        <span className="inline-flex items-center gap-1 ml-1 align-middle">
                                            <span className="w-1 h-1 rounded-full bg-purple-500 animate-bounce [animation-delay:-0.3s]"></span>
                                            <span className="w-1 h-1 rounded-full bg-purple-500 animate-bounce [animation-delay:-0.15s]"></span>
                                            <span className="w-1 h-1 rounded-full bg-purple-500 animate-bounce"></span>
                                        </span>
                                    )}
                                </div>
                            </div>
                        </div>
                    ) : (
                        <>
                            <div className="border-l-2 border-gray-200 pl-3.5 text-xs text-gray-500 mb-6 leading-relaxed transition-all duration-300">

                      {isExpanded ? (
                        <span>
                            ç”Ÿæœç›´æ’­è´­ç‰©è¢‹å¼¹å‡ºåé®æŒ¡ç”»é¢ä¸»ä½“ï¼Œå½±å“ç”¨æˆ·è§‚çœ‹ä¸å†³ç­–æ•ˆç‡ã€‚å®éªŒç»„ï¼ˆv1ï¼‰é€šè¿‡ç”»é¢ä¸Šç§»åŠå–æ¶ˆè’™å±‚ä¼˜åŒ–ä½“éªŒï¼Œå¯¹ç…§ç»„ï¼ˆv0ï¼‰ä¿æŒåŸå§‹æ ·å¼ã€‚æœŸæœ›èƒ½å¤Ÿå®éªŒç­–ç•¥èƒ½æå‡GMVä¸è®¢å•é‡ï¼Œæ”¹å–„è´­ç‰©è¢‹è½¬åŒ–æ•ˆç‡ã€‚
                            <span onClick={() => setIsExpanded(false)} className="text-indigo-500 cursor-pointer hover:underline font-medium ml-1">æ”¶èµ·</span>
                        </span>
                      ) : (
                        <span>
                            ç”Ÿæœç›´æ’­è´­ç‰©è¢‹å¼¹å‡ºåé®æŒ¡ç”»é¢ä¸»ä½“ï¼Œå½±å“ç”¨æˆ·è§‚çœ‹ä¸å†³ç­–æ•ˆç‡ã€‚å®éªŒç»„ï¼ˆv1ï¼‰é€šè¿‡ç”»é¢ä¸Šç§»åŠå–æ¶ˆè’™å±‚ä¼˜åŒ–ä½“éªŒ...
                            <span onClick={() => setIsExpanded(true)} className="text-indigo-500 cursor-pointer hover:underline font-medium ml-1">å±•å¼€</span>
                        </span>
                      )}
                    </div>

                    <div className="space-y-6">
                        {THINKING_STEPS.map((step, idx) => (
                           <div key={step.id}>
                              {/* Section Header */}
                              <div className="flex justify-center mb-3">
                                  <div className="bg-indigo-50 text-indigo-900 px-4 py-1.5 rounded-[8px] text-[13px] font-bold w-full text-center">
                                      {step.title}
                                  </div>
                              </div>
                              
                              {/* Section Description */}
                              {step.description && (
                                   <div className="text-[11px] text-gray-400 mb-2 px-1 text-center">
                                       {step.description}
                                   </div>
                              )}
                              
                              <div className="space-y-1.5 pl-1">
                                  {step.groups.map((group, i) => (
                                      <ThinkingCard key={i} group={group} onClick={onScrollTo} analyzedMetrics={analyzedMetrics} onAnalysisClick={onAnalysisClick} />
                                  ))}
                              </div>
                           </div>
                        ))}
                    </div>
                  </>
                )}
                </>
              )}
                  </div>
              </div>
              
              {/* Notification Bar */}
              <div 
                  className={cn(
                      "absolute bottom-5 left-0 right-0 mx-5 z-30 transition-all duration-300 transform",
                      hasBlockChanges && !activeAnalysis ? "translate-y-0 opacity-100" : "translate-y-10 opacity-0 pointer-events-none"
                  )}
              >
                  <div 
                      className="bg-indigo-600 text-white px-4 py-3 rounded-lg shadow-lg flex items-center justify-between cursor-pointer hover:bg-indigo-700 transition-colors"
                      onClick={onRefresh}
                  >
                      <div className="flex items-center space-x-2">
                          <Sparkles size={16} className="animate-pulse" />
                          <span className="text-xs font-medium">æœ‰æŒ‡æ ‡å˜åŠ¨ï¼Œè®©æˆ‘å¸®ä½ é‡æ–°æ¢³ç†</span>
                      </div>
                      <ArrowRight size={14} />
                  </div>
              </div>
            </div>
          );
        };

        const EditPromptArea = () => (
            <Card className="mt-8 border-dashed shadow-none">
                 <CardContent className="flex flex-col items-center justify-center text-center p-12 space-y-4 relative">
                     <div className="absolute top-4 left-4 flex items-center text-muted-foreground text-xs">
                        <span className="mr-2">ç›‘æ§æŒ‡æ ‡</span>
                     </div>
                     <div className="absolute top-4 right-4">
                        <PromptEditorButton variant="outline" size="sm" className="h-7 text-xs" />
                     </div>

                     <div className="w-full max-w-lg border border-dashed border-red-200 bg-red-50/30 rounded-lg p-10 flex flex-col items-center justify-center">
                         <span className="text-red-500 text-sm font-medium mb-2">åšä¸€äº›ç©ºæ€å¼•å¯¼ï¼Œè¿™é‡Œä»…å±•ç¤ºå ä½</span>
                         <p className="text-xs text-muted-foreground mb-8">æ‹–å…¥æ–‡ä»¶ï¼Œå¿«é€Ÿå¼€å§‹ Book ç¼–è¾‘å§~</p>
                         <div className="flex space-x-4 w-full justify-center">
                              <div className="bg-background border p-3 rounded-md w-32 text-left shadow-sm hover:shadow-md cursor-pointer transition-all">
                                  <div className="flex items-center text-xs font-bold text-foreground mb-1"><span className="mr-2">ğŸ”—</span> æ•°æ®å¯¼å…¥</div>
                                  <p className="text-[10px] text-muted-foreground">ç¬¬ä¸‰æ–¹æ•°æ®å¯¼å…¥...</p>
                              </div>
                              <div className="bg-background border p-3 rounded-md w-32 text-left shadow-sm hover:shadow-md cursor-pointer transition-all">
                                  <div className="flex items-center text-xs font-bold text-foreground mb-1"><span className="mr-2">ğŸ“‚</span> MagiSDK</div>
                                  <p className="text-[10px] text-muted-foreground">ä½¿ç”¨ SDK é“¾æ¥...</p>
                              </div>
                               <div className="bg-background border p-3 rounded-md w-32 text-left shadow-sm hover:shadow-md cursor-pointer transition-all">
                                  <div className="flex items-center text-xs font-bold text-foreground mb-1"><span className="mr-2">ğŸ</span> Python</div>
                                  <p className="text-[10px] text-muted-foreground">ä¹Ÿè®¸åªæƒ³ç”¨Python...</p>
                              </div>
                         </div>
                     </div>
                 </CardContent>
            </Card>
        )



        const SectionContainer = ({ section, onUpdateSection, activeAddMenuId, setActiveAddMenuId, handleSelectBlockType, renderBlockContent }) => {
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [tempTitle, setTempTitle] = useState(section.title);
            const [isCollapsed, setIsCollapsed] = useState(false);

            const handleTitleSave = () => {
                onUpdateSection({ ...section, title: tempTitle });
                setIsEditingTitle(false);
            };

            const handleDeleteBlock = (id) => {
                onUpdateSection({ ...section, blocks: section.blocks.filter(block => block.id !== id) });
            };

            const handleUpdateBlocks = (newBlocks) => {
                onUpdateSection({ ...section, blocks: newBlocks });
            };

            const handleOpenAddMenu = (id) => {
                setActiveAddMenuId(id);
            };

            const handleCloseAddMenu = () => {
                setActiveAddMenuId(null);
            };

            const [hoveredBlockId, setHoveredBlockId] = useState(null);

            const getLevelValue = (levelStr) => {
                switch(levelStr) {
                    case 'ä¸€çº§': return 1;
                    case 'äºŒçº§': return 2;
                    case 'ä¸‰çº§': return 3;
                    default: return 99;
                }
            };

            const visibleBlocks = (() => {
                const blocks = [];
                let collapseThreshold = Infinity;

                section.blocks.forEach(block => {
                    if (block.type === 'divider') {
                        const level = getLevelValue(block.level);
                        if (level <= collapseThreshold) {
                            collapseThreshold = block.isCollapsed ? level : Infinity;
                            blocks.push(block);
                        }
                    } else {
                        if (collapseThreshold === Infinity) {
                            blocks.push(block);
                        }
                    }
                });
                return blocks;
            })();

            return (
                <div className="mb-5 p-3 pb-[24px] -mx-3 bg-white hover:bg-[#FAFBFC] transition-colors duration-200 rounded-xl" id={section.id}>
                    <div className="flex items-center justify-between mb-2 group h-auto">
                        <div className="flex items-center">
                            {isEditingTitle ? (
                                <input 
                                    value={tempTitle} 
                                    onChange={(e) => setTempTitle(e.target.value)} 
                                    onBlur={handleTitleSave}
                                    onKeyDown={(e) => e.key === 'Enter' && handleTitleSave()}
                                    className="text-[14px] font-medium px-2 h-7 border rounded focus:outline-none focus:ring-2 focus:ring-primary w-auto bg-transparent"
                                    autoFocus
                                />
                            ) : (
                                <>
                                    <img src="/assets/images/icon/file.svg" className="mr-2 w-[18px] h-[18px]" />
                                    <h2 className="text-[16px] text-foreground font-medium px-1 select-none">{section.title}</h2>
                                    <Button 
                                        variant="ghost"  
                                        size="icon" 
                                        className="h-6 w-6 ml-2 opacity-0 group-hover:opacity-100 transition-opacity text-muted-foreground hover:text-primary" 
                                        onClick={() => setIsEditingTitle(true)}
                                    >
                                        <Pencil size={14} />
                                    </Button>
                                </>
                            )}
                        </div>
                        <PromptEditorButton variant="outline" size="sm" className="h-6 text-xs bg-white border text-foreground/70 hover:bg-gray-50 transition-all opacity-0 group-hover:opacity-100" />
                    </div>
                    
                    <div className="space-y-4">
                        {visibleBlocks.map((block, index) => (
                            <BlockWrapper 
                                key={block.id} 
                                id={block.id} 
                                type={block.type}
                                onDelete={handleDeleteBlock} 
                                onInsertAfter={handleOpenAddMenu}
                                isHovered={hoveredBlockId}
                                setIsHovered={setHoveredBlockId}
                                showAddMenu={activeAddMenuId === block.id}
                                onAddMenuSelect={(type) => handleSelectBlockType(type, section.id, block.id)}
                                onCloseMenu={handleCloseAddMenu}
                            >
                                {renderBlockContent(block, section.id, index === 0)}
                            </BlockWrapper>
                        ))}
                    </div>
                        <div className="mt-4">
                        <AddBlockArea 
                            onSelect={(type) => {
                                handleSelectBlockType(type, section.id, 'end');
                            }}
                        />
                    </div>
                </div>
            );
        };

        const FilterPanel = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="absolute top-full left-0 mt-2 bg-background border rounded-lg shadow-xl p-4 z-50 w-[400px] animate-in fade-in zoom-in-95 duration-200">
                    <div className="space-y-4">
                        <div className="space-y-2">
                            <label className="text-xs font-medium text-muted-foreground">å®éªŒåˆ†ç»„</label>
                            <div className="flex flex-wrap gap-2">
                                <Badge variant="secondary" className="cursor-pointer hover:bg-muted">å¯¹ç…§ç»„</Badge>
                                <Badge variant="secondary" className="cursor-pointer hover:bg-muted">å®éªŒç»„V1</Badge>
                                <Badge variant="secondary" className="cursor-pointer hover:bg-muted">å®éªŒç»„V2</Badge>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <label className="text-xs font-medium text-muted-foreground">æœºæˆ¿</label>
                            <div className="flex flex-wrap gap-2">
                                <Badge variant="outline" className="cursor-pointer hover:bg-muted border-primary text-primary">ä¸­å›½æœºæˆ¿</Badge>
                                <Badge variant="outline" className="cursor-pointer hover:bg-muted">æ–°åŠ å¡æœºæˆ¿</Badge>
                                <Badge variant="outline" className="cursor-pointer hover:bg-muted">ç¾å›½æœºæˆ¿</Badge>
                            </div>
                        </div>
                        <div className="space-y-2">
                            <label className="text-xs font-medium text-muted-foreground">å…¨å±€ç»´åº¦</label>
                            <div className="grid grid-cols-2 gap-2">
                                <div className="border rounded px-2 py-1.5 text-xs flex justify-between items-center cursor-pointer hover:bg-muted">
                                    <span>å¹³å°</span>
                                    <ChevronDown size={12} className="text-muted-foreground"/>
                                </div>
                                <div className="border rounded px-2 py-1.5 text-xs flex justify-between items-center cursor-pointer hover:bg-muted">
                                    <span>ç‰ˆæœ¬</span>
                                    <ChevronDown size={12} className="text-muted-foreground"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
          // --- State ---
          const [showThinkingSidebar, setShowThinkingSidebar] = useState(true);
          const [summaryData, setSummaryData] = useState([
                { 
                    title: 'æ ¸å¿ƒæŒ‡æ ‡æ˜¾è‘—æå‡å®éªŒç»„åœ¨æ ¸å¿ƒäº¤æ˜“æŒ‡æ ‡å–å¾—æ­£å‘æ”¶ç›Šï¼š', 
                    content: (
                        <span>
                            <span className="inline-flex items-center bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded mx-1 text-xs font-medium">ç›´æ’­GMV</span> 
                            æ˜¾è‘—æå‡ 
                            <span className="inline-flex items-center bg-green-50 text-green-600 px-1.5 py-0.5 rounded mx-1 text-xs font-bold">+6.27%</span> 
                            ï¼Œ
                            <span className="inline-flex items-center bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded mx-1 text-xs font-medium">ç›´æ’­äººå‡è®¢å•æ•°</span>
                             æ˜¾è‘—æå‡ 
                            <span className="inline-flex items-center bg-green-50 text-green-600 px-1.5 py-0.5 rounded mx-1 text-xs font-bold">+7.27%</span> 
                            ï¼ŒéªŒè¯äº†ç”»é¢è‡ªé€‚åº”å¯¹äº¤æ˜“æ•ˆç‡çš„ä¿ƒè¿›ä½œç”¨ã€‚
                        </span>
                    ) 
                },
                { 
                    title: 'ç”¨æˆ·è¡Œä¸ºåˆ†åŒ–æ˜æ˜¾ï¼š', 
                    content: (
                        <span>
                            å•†å®¶è‡ªæ’­åœºæ™¯è¡¨ç°æœ€ä½³ï¼š 
                            <span className="inline-flex items-center bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded mx-1 text-xs font-medium">æ”¯ä»˜UVæ¸—é€ç‡</span> 
                            <span className="inline-flex items-center bg-green-50 text-green-600 px-1.5 py-0.5 rounded mx-1 text-xs font-bold">+0.16%</span>
                            ï¼Œ
                            <span className="inline-flex items-center bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded mx-1 text-xs font-medium">äººå‡è®¢å•æ•°</span> 
                            <span className="inline-flex items-center bg-green-50 text-green-600 px-1.5 py-0.5 rounded mx-1 text-xs font-bold">+0.29%</span>
                             æ˜¾è‘—æå‡ï¼Œè‡ªé€‚åº”ç­–ç•¥æ›´å¥‘åˆå•†å“è®²è§£å‹ç›´æ’­ã€‚
                        </span>
                    ) 
                },
                { 
                    title: 'æ”¯ä»˜æ´»è·ƒç”¨æˆ·æ”¶ç›Šæ˜¾è‘—ï¼š', 
                    content: (
                        <span>
                            <span className="inline-flex items-center bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded mx-1 text-xs font-medium">äººå‡è®¢å•æ•°</span>
                            <span className="inline-flex items-center bg-green-50 text-green-600 px-1.5 py-0.5 rounded mx-1 text-xs font-bold">+7.27%</span>
                             å’Œ 
                            <span className="inline-flex items-center bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded mx-1 text-xs font-medium">ç›´æ’­GMV</span>
                            <span className="inline-flex items-center bg-green-50 text-green-600 px-1.5 py-0.5 rounded mx-1 text-xs font-bold">+6.27%</span>
                             æå‡ï¼Œè€Œ
                            <span className="inline-flex items-center bg-gray-100 text-gray-700 px-1.5 py-0.5 rounded mx-1 text-xs font-medium">æ”¯ä»˜æµå¤±ç”¨æˆ·è´§æ¶æ”¯ä»˜CVR</span>
                            <span className="inline-flex items-center bg-red-50 text-red-600 px-1.5 py-0.5 rounded mx-1 text-xs font-bold">-1.10%</span>
                             ä¸‹é™
                            ï¼Œéœ€å…³æ³¨æµå¤±ç”¨æˆ·å¯¹æ–°äº¤äº’çš„é€‚åº”æ€§ã€‚
                        </span>
                    ) 
                }
          ]);

          const contentRef = useRef(null);

          const [sections, setSections] = useState([
              {
                  id: 'core_focus',
                  title: 'å®éªŒæ ¸å¿ƒå…³æ³¨',
                  blocks: [
                    { 
                        id: 'divider-1', 
                        type: 'divider', 
                        level: 'äºŒçº§', 
                        title: 'ç”µå•†æ ¸å¿ƒæŒ‡æ ‡' 
                    },
                    { 
                        id: 'text-1', 
                        type: 'text', 
                        level: 'ä¸€çº§', 
                        title: 'æ–‡æœ¬', 
                        content: `<ul>
    <li>
        <p><strong>å®éªŒç»„æ•´ä½“</strong>ï¼š<span style="background-color: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">ç›´æ’­GMV</span> æå‡ <span style="color: #15803d; background-color: #dcfce7; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em;">+0.15%</span> ï¼Œ<span style="background-color: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">æ€»è®¢å•é‡</span> åŒæ­¥æå‡ <span style="color: #15803d; background-color: #dcfce7; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em;">+0.15%</span>ï¼ŒéªŒè¯äº†ç”»é¢è‡ªé€‚åº”å¯¹äº¤æ˜“æ•ˆç‡çš„ä¼˜åŒ–ä½œç”¨ã€‚</p>
    </li>
    <li>
        <p><strong>è¿‡ç¨‹æŒ‡æ ‡å½’å› ï¼š</strong></p>
        <p style="margin-top: 0.5em;"><span style="background-color: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">è´§æ¶å¡ç‰‡ç‚¹å‡»æ¸—é€ç‡</span> æ˜¾è‘—æå‡ <span style="color: #15803d; background-color: #dcfce7; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em;">+0.24%</span> ï¼Œè¯´æ˜éœ²å‡ºç”»é¢ä¸»ä½“åç”¨æˆ·æ›´æ˜“å‘ç°å¹¶ç‚¹å‡»è´§æ¶ã€‚</p>
        <p style="margin-top: 0.5em;"><span style="background-color: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">ç›´æ’­æ”¯ä»˜CTCVR</span> æå‡ <span style="color: #15803d; background-color: #dcfce7; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.9em;">+0.16%</span> ï¼Œè¡¨æ˜ä»ç‚¹å‡»åˆ°æ”¯ä»˜çš„é“¾è·¯ç¼©çŸ­ï¼Œå†³ç­–æ•ˆç‡æé«˜ã€‚</p>
    </li>
</ul>` 
                    },
                    { 
                        id: 'table-1', 
                        type: 'table', 
                        title: 'APP - æ ¸å¿ƒæŒ‡æ ‡', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    },
                    { 
                        id: 'table-2', 
                        type: 'table', 
                        title: 'ç”µå•† - ä¸šåŠ¡æ ¸å¿ƒ - è‡ªç„¶æµé‡', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    },
                    { 
                        id: 'table-3', 
                        type: 'table', 
                        title: 'ç”Ÿæ´»æœåŠ¡-ç›´æ’­ç”¨æˆ·æ ¸å¿ƒæŒ‡æ ‡', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    },
                    { 
                        id: 'divider-2', 
                        type: 'divider', 
                        level: 'äºŒçº§', 
                        title: 'ç»†åˆ†æ–¹å‘' 
                    },
                    { 
                        id: 'table-4', 
                        type: 'table', 
                        title: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-åˆ†ç»„ä»¶äº¤æ˜“é“¾è·¯æ˜ç»†', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    },
                    { 
                        id: 'table-5', 
                        type: 'table', 
                        title: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-å•†å“åˆ†è¡Œä¸šæ ¸å¿ƒæŒ‡æ ‡', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    },
                    { 
                        id: 'divider-3', 
                        type: 'divider', 
                        level: 'äºŒçº§', 
                        title: 'ç›´æ’­è½¬åŒ–é“¾è·¯' 
                    },
                    { 
                        id: 'analysis-1', 
                        type: 'analysis_card', 
                        title: 'ç”Ÿæ´»æœåŠ¡-ç›´æ’­ç”¨æˆ·æ ¸å¿ƒæŒ‡æ ‡', 
                        metricType: 'CUPED',
                        groupName: 'ç”Ÿæ´»æœåŠ¡-ç›´æ’­ç”¨æˆ·æ ¸å¿ƒæŒ‡æ ‡',
                        dimensionName: 'room_type (ç›´æ’­é—´ç±»å‹)' 
                    },
                    { 
                        id: 'table-6', 
                        type: 'table', 
                        title: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-ç”¨æˆ·çœ‹æ’­æŒ‡æ ‡', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    },
                    { 
                        id: 'table-7', 
                        type: 'table', 
                        title: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-å†…å®¹æ¶ˆè´¹æŒ‡æ ‡ç»„', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    },
                    { 
                        id: 'table-8', 
                        type: 'table', 
                        title: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-äº¤æ˜“é“¾è·¯', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    },
                    { 
                        id: 'table-9', 
                        type: 'table', 
                        title: 'ä¸šåŠ¡æ ¸å¿ƒæŒ‡æ ‡-ç›´æ’­', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    },
                    { 
                        id: 'table-10', 
                        type: 'table', 
                        title: 'ä¸šåŠ¡åŸºç¡€æŒ‡æ ‡(æ¨è)', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    },
                    { 
                        id: 'table-11', 
                        type: 'table', 
                        title: 'shopping_cart vv', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    }
                  ]
              },
              {
                  id: 'monitor_metrics',
                  title: 'å…¶ä»–ç›‘æµ‹æŒ‡æ ‡',
                  blocks: [
                     { 
                        id: 'table-12', 
                        type: 'table', 
                        title: 'ç”Ÿæ´»æœåŠ¡ç›´æ’­-å•†å“åˆ†è¡Œä¸šæ ¸å¿ƒæŒ‡æ ‡', 
                        level: 'ä¸€çº§', 
                        data: LIVE_METRICS_DATA, 
                        columns: LIVE_METRICS_COLUMNS 
                    }
                  ]
              }
          ]);

          const [activeAddMenuId, setActiveAddMenuId] = useState(null);

          // --- Handlers ---
          
          const handleUpdateSection = (updatedSection) => {
              setSections(sections.map(s => s.id === updatedSection.id ? updatedSection : s));
          };

          const handleUpdateSectionTitle = (sectionId, newTitle) => {
              setSections(sections.map(s => s.id === sectionId ? { ...s, title: newTitle } : s));
          };

          const handleSelectBlockType = (type, sectionId, insertAfterId) => {
              const newBlockId = `new-block-${Date.now()}`;
              let newBlock = { id: newBlockId };

              switch (type) {
                  case 'metric':
                      newBlock = { ...newBlock, type: 'metric_selector' };
                      break;
                  case 'analysis':
                      newBlock = { ...newBlock, type: 'analysis_selector' };
                      break;
                  case 'smart':
                      newBlock = { ...newBlock, type: 'ask_ai' };
                      break;
                  case 'text':
                      newBlock = { ...newBlock, type: 'text', level: 'æ–°æ¨¡å—', title: 'æ–‡æœ¬å—', content: '' };
                      break;
                  case 'group':
                      newBlock = { ...newBlock, type: 'divider', title: 'æ–°åˆ†ç»„', level: 'ä¸€çº§' };
                      break;
                  default:
                      return;
              }

              const sectionIndex = sections.findIndex(s => s.id === sectionId);
              if (sectionIndex === -1) return;

              const section = sections[sectionIndex];
              let newBlocks = [...section.blocks];

              if (insertAfterId === 'end') {
                  newBlocks.push(newBlock);
              } else {
                  const blockIndex = newBlocks.findIndex(b => b.id === insertAfterId);
                  if (blockIndex !== -1) {
                      newBlocks.splice(blockIndex + 1, 0, newBlock);
                  }
              }

              const newSection = { ...section, blocks: newBlocks };
              const newSections = [...sections];
              newSections[sectionIndex] = newSection;
              setSections(newSections);
              
              setActiveAddMenuId(null);
          };

          const handleConfirmSelector = (blockId, data, sectionId) => {
              const sectionIndex = sections.findIndex(s => s.id === sectionId);
              if (sectionIndex === -1) return;

              const section = sections[sectionIndex];
              const newBlocks = section.blocks.map(b => {
                  if (b.id !== blockId) return b;
                  
                  if (b.type === 'metric_selector') {
                      return { 
                          ...b, 
                          type: 'table', 
                          title: data, 
                          level: 'ä¸€çº§', 
                          data: LIVE_METRICS_DATA, 
                          columns: LIVE_METRICS_COLUMNS 
                      };
                  }
                  if (b.type === 'analysis_selector') {
                       return { 
                          ...b, 
                          type: 'analysis_card', 
                          title: data, 
                          metricType: 'CUPED'
                      };
                  }

                  return b;
              });

              const newSection = { ...section, blocks: newBlocks };
              const newSections = [...sections];
              newSections[sectionIndex] = newSection;
              setSections(newSections);
              setHasBlockChanges(true);
          };

          const handleMoveBlock = (sourceSectionId, sourceBlockId, targetSectionId, targetBlockId, position) => {
              if (sourceBlockId === targetBlockId) return;

              const sourceSectionIndex = sections.findIndex(s => s.id === sourceSectionId);
              const targetSectionIndex = sections.findIndex(s => s.id === targetSectionId);
              
              if (sourceSectionIndex === -1 || targetSectionIndex === -1) return;

              const newSections = [...sections];

              if (sourceSectionId === targetSectionId) {
                   const section = { ...newSections[sourceSectionIndex] };
                   const blocks = [...section.blocks];
                   
                   const sIdx = blocks.findIndex(b => b.id === sourceBlockId);
                   if (sIdx === -1) return;
                   
                   const [item] = blocks.splice(sIdx, 1);
                   
                   // Find target index in the modified array (target might have shifted)
                   // But wait, if target was AFTER source, its index shifted -1.
                   // If target was BEFORE source, its index is same.
                   // Using findIndex on the modified array is safe IF target is not the source (checked above).
                   let tIdx = blocks.findIndex(b => b.id === targetBlockId);
                   
                   if (tIdx === -1) {
                       // Should not happen if target !== source and target exists
                       // Fallback to append?
                       tIdx = blocks.length;
                   } else {
                       if (position === 'after') tIdx += 1;
                   }
                   
                   blocks.splice(tIdx, 0, item);
                   
                   newSections[sourceSectionIndex] = { ...section, blocks };
              } else {
                   const sourceSection = { ...newSections[sourceSectionIndex] };
                   const targetSection = { ...newSections[targetSectionIndex] };
                   
                   // Create new block arrays
                   const sourceBlocks = [...sourceSection.blocks];
                   const targetBlocks = [...targetSection.blocks];

                   const sIdx = sourceBlocks.findIndex(b => b.id === sourceBlockId);
                   if (sIdx === -1) return;
                   
                   const [item] = sourceBlocks.splice(sIdx, 1);
                   
                   let tIdx = targetBlocks.findIndex(b => b.id === targetBlockId);
                   if (tIdx === -1) {
                        tIdx = targetBlocks.length;
                   } else {
                       if (position === 'after') tIdx += 1;
                   }
                   
                   targetBlocks.splice(tIdx, 0, item);
                   
                   newSections[sourceSectionIndex] = { ...sourceSection, blocks: sourceBlocks };
                   newSections[targetSectionIndex] = { ...targetSection, blocks: targetBlocks };
              }

              setSections(newSections);
              setHasBlockChanges(true);
          };

          const [hasBlockChanges, setHasBlockChanges] = useState(false);

          const handleUpdateBlock = (sectionId, blockId, newData) => {
              const sectionIndex = sections.findIndex(s => s.id === sectionId);
              if (sectionIndex === -1) return;

              const section = sections[sectionIndex];
              const newBlocks = section.blocks.map(b => {
                  if (b.id === blockId) {
                      return { ...b, ...newData };
                  }
                  return b;
              });

              const newSection = { ...section, blocks: newBlocks };
              const newSections = [...sections];
              newSections[sectionIndex] = newSection;
              setSections(newSections);
          };

          const [activeAnalysis, setActiveAnalysis] = useState(null);
          const [analyzedMetrics, setAnalyzedMetrics] = useState([]);

          const handleTriggerAIAnalysis = (title) => {
              const isFirstTime = !analyzedMetrics.includes(title);
              // Open ThinkingSidebar and set to analysis mode
              setShowThinkingSidebar(true);
              setActiveAnalysis({
                  title: title,
                  isStreaming: isFirstTime // Only stream if it's the first time
              });
              if (isFirstTime) {
                  setAnalyzedMetrics(prev => [...prev, title]);
              }
          };

          const renderBlockContent = (block, sectionId, isFirst) => {
              switch (block.type) {
                  case 'summary': return <SummaryBlock data={block.data} isFirst={isFirst} />;
                  case 'text': return <TextBlock title={block.title} content={block.content} level={block.level} onUpdateContent={(newContent) => handleUpdateBlock(sectionId, block.id, { content: newContent })} />;
                  case 'table': return <TableBlock title={block.title} data={block.data} columns={block.columns} level={block.level} onTriggerAIAnalysis={(t) => handleTriggerAIAnalysis(t ? `${block.title}/${t}` : block.title)} />;
                  case 'divider': return <DividerBlock 
                      title={block.title} 
                      level={block.level} 
                      onUpdateLevel={(newLevel) => handleUpdateBlock(sectionId, block.id, { level: newLevel })} 
                      onUpdateTitle={(newTitle) => handleUpdateBlock(sectionId, block.id, { title: newTitle })} 
                      isCollapsed={block.isCollapsed}
                      onToggleCollapse={() => handleUpdateBlock(sectionId, block.id, { isCollapsed: !block.isCollapsed })}
                  />;
                  case 'analysis_card': return <AnalysisCardBlock title={block.title} metricType={block.metricType} groupName={block.groupName} dimensionName={block.dimensionName}/>;
                  case 'ask_ai': return <AskAIBlock sections={sections} />;
                  case 'edit_prompt': return <EditPromptArea />;
                  case 'metric_selector': return <MetricSelectorBlock onConfirm={(data) => handleConfirmSelector(block.id, data, sectionId)} />;
                  case 'analysis_selector': return <AnalysisSelectorBlock onConfirm={(data) => handleConfirmSelector(block.id, data, sectionId)} />;

                  default: return <div>Unknown Block Type: {block.type}</div>;
              }
          };

          const handleAddSection = () => {
              const newSectionId = `section-${Date.now()}`;
              const newSection = {
                  id: newSectionId,
                  title: 'æ–°å»ºæ¨¡å—',
                  blocks: []
              };
              setSections([...sections, newSection]);
              
              // Optional: Scroll to new section after a slight delay to allow rendering
              setTimeout(() => {
                  const element = document.getElementById(newSectionId);
                  if (element) {
                      element.scrollIntoView({ behavior: 'smooth' });
                  }
              }, 100);
          };

          const scrollToBlock = (id) => {
              // Removed setActiveId(id) call as it is not defined in App scope.
              // If sidebar highlighting is needed, state should be lifted or managed via context/events.
              
              const element = document.getElementById(id);
              if (element && contentRef.current) {
                  // Use scrollIntoView which works within overflow containers
                  element.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
          };

          const [isFilterOpen, setIsFilterOpen] = useState(false);
          const filterRef = useRef(null);

          useEffect(() => {
              const handleClickOutside = (event) => {
                  if (filterRef.current && !filterRef.current.contains(event.target)) {
                      setIsFilterOpen(false);
                  }
              };
              document.addEventListener('mousedown', handleClickOutside);
              return () => document.removeEventListener('mousedown', handleClickOutside);
          }, []);

          const [isRefreshing, setIsRefreshing] = useState(false);

          const onRefresh = () => {
              setHasBlockChanges(false);
              setIsRefreshing(true);
              // Simulate refresh process
              setTimeout(() => {
                  setIsRefreshing(false);
              }, 5000);
          };

          return (
            <div className="min-h-screen flex flex-col bg-muted/5 pt-12">
              <GlobalHeader />
              <ExperimentToolbar />
              
              <div className="flex flex-1 w-full min-w-0 items-stretch p-3 bg-[#F7F8F9]">
                {/* Container B: Main Workspace Card */}
                <div className="flex flex-col flex-1 bg-background rounded-lg overflow-hidden h-[calc(100vh-168px)] transition-all duration-300 ease-in-out">
                    
                    {/* Filter Bar (Moved to top of Container B) */}
                    <div className="flex justify-between items-center px-6 py-3 border-b border-border/50 bg-background z-20 relative">
                        <div className="flex items-center">
                            <div className="flex items-center rounded-md px-3 py-1 hover:bg-muted/50 transition-colors cursor-pointer mr-4 group h-6">
                                <Calendar size={14} className="mr-2 text-muted-foreground group-hover:text-primary"/>
                                <span className="font-medium text-[13px] text-foreground group-hover:text-primary">2025-01-01</span>
                                <span className="mx-2 text-[13px] text-muted-foreground">-</span>
                                <span className="font-medium text-[13px] text-foreground group-hover:text-primary">2025-01-20</span>
                            </div>
                            <div className="relative" ref={filterRef}>
                                <Button
                                    variant="ghost"
                                    className="h-6 px-3 py-1 text-[13px] font-medium text-foreground hover:bg-muted/50 group"
                                    onClick={() => setIsFilterOpen(!isFilterOpen)}
                                >
                                    <Filter size={14} className="text-muted-foreground mr-2 group-hover:text-primary"/> 
                                    <span className="font-medium text-[13px] text-foreground group-hover:text-primary">æ•°æ®æ¡ä»¶</span>
                                    <Badge variant="secondary" className="ml-1.5 h-5 px-1.5 text-[10px] bg-blue-50 text-blue-600 hover:bg-blue-100">3</Badge>
                                </Button>
                                <FilterPanel isOpen={isFilterOpen} onClose={() => setIsFilterOpen(false)} />
                            </div>
                        </div>
                        <div className="flex items-center space-x-4 pr-2">
                            <div 
                                className="flex items-center bg-gradient-to-r from-blue-50/80 to-indigo-50/80 border rounded-md py-1 px-3 cursor-pointer hover:transition-all group"
                                onClick={() => setShowThinkingSidebar(!showThinkingSidebar)}
                            >
                                <span className={cn("text-[13px] mr-3 font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent transition-all", !showThinkingSidebar && "opacity-70 grayscale")}>çœ‹æ•°æ€è·¯</span>
                                <div className={cn("w-8 h-4 rounded-full relative transition-all duration-300", showThinkingSidebar ? "bg-blue-600" : "bg-slate-300")}>
                                    <div className={cn("w-3 h-3 bg-white rounded-full absolute top-0.5 shadow-sm transition-all duration-300", showThinkingSidebar ? "right-0.5" : "left-0.5")}></div>
                                </div>
                            </div>
                             <Button size="sm" className="btn-ai-report text-white font-bold border-0">
                                <img src="assets/images/icon/AIstar.svg" width="14" height="14" className="mr-2" style={{ filter: 'brightness(0) invert(1)' }} alt="AI" /> AI å†™æŠ¥å‘Š
                             </Button>
                        </div>
                    </div>

                    {/* Container A: Sidebar + Center Content */}
                    <div className="relative flex flex-1 items-stretch overflow-hidden">
                        <Sidebar 
                            sections={sections} 
                            onUpdateSectionTitle={handleUpdateSectionTitle} 
                            onAddSection={handleAddSection} 
                            onAddBlock={(sectionId, type) => handleSelectBlockType(type, sectionId, 'end')}
                            contentRef={contentRef}
                            scrollToBlock={scrollToBlock}
                        />

                        <div className="flex-1 min-w-0 bg-muted/5 overflow-y-auto" ref={contentRef}>
                          <div className="px-8 py-4 mx-auto">
                            
                            {/* Experiment Summary (Fixed) */}
                            <div className="mb-5">
                                 <SummaryBlock data={summaryData} />
                            </div>

                            {/* Dynamic Sections */}
                            {sections.map(section => (
                                <SectionContainer 
                                    key={section.id}
                                    section={section}
                                    onUpdateSection={handleUpdateSection}
                                    activeAddMenuId={activeAddMenuId}
                                    setActiveAddMenuId={setActiveAddMenuId}
                                    handleSelectBlockType={handleSelectBlockType}
                                    renderBlockContent={renderBlockContent}
                                    onMoveBlock={handleMoveBlock}
                                />
                            ))}

                            {/* Add New Section Button */}
                            <div className="flex justify-center mb-12">
                                <Button variant="outline" className="border-dashed border-2 w-full h-16 text-muted-foreground hover:text-primary hover:border-primary/50 hover:bg-primary/5" onClick={handleAddSection}>
                                    <Plus size={20} className="mr-2" />
                                    æ·»åŠ æ–°æ¨¡å—
                                </Button>
                            </div>

                             <div className="fixed bottom-0 left-0 w-full flex justify-center z-50 pointer-events-none">
                                 <Button variant="outline" size="md" className="text-muted-foreground text-[13px] bg-white/90 backdrop-blur-sm shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] hover:bg-white hover:text-foreground pointer-events-auto rounded-t-[12px] rounded-b-none border-b-0 px-8 h-10">
                                    è¿”å›ä¼ ç»Ÿæ¨¡å¼ <span className="ml-2">â†’</span>
                                </Button>
                            </div>

                          </div>
                        </div>
                    </div>
                </div>

                <ThinkingSidebar 
                    isVisible={showThinkingSidebar} 
                    onClose={() => setShowThinkingSidebar(false)} 
                    activeAnalysis={activeAnalysis}
                    onCloseAnalysis={() => setActiveAnalysis(null)}
                    analyzedMetrics={analyzedMetrics}
                    onAnalysisClick={handleTriggerAIAnalysis}
                    hasBlockChanges={hasBlockChanges}
                    onRefresh={onRefresh}
                    isRefreshing={isRefreshing}
                    onScrollTo={(label) => {
                        // Find section/block with matching title or dimensionName
                        const foundBlock = sections.flatMap(s => s.blocks).find(b => 
                            b.title === label || 
                            b.title?.includes(label) ||
                            b.dimensionName === label
                        );
                        if (foundBlock) {
                            scrollToBlock(foundBlock.id);
                        } else {
                            // If not found in current blocks, maybe try to match sections
                            const foundSection = sections.find(s => s.title === label || s.title?.includes(label));
                            if (foundSection) {
                                // Scroll to the first block of the section or the section itself if we had IDs for sections in DOM
                                if (foundSection.blocks.length > 0) {
                                    scrollToBlock(foundSection.blocks[0].id);
                                }
                            }
                        }
                    }}
                />
              </div>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
